<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>كشف المتابعة اليومي</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .tab {
            overflow: hidden;
            background-color: #f1f1f1;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 5px;
            border-radius: 8px;
        }
        .tab button {
            flex: 0 0 auto;
            border: 2px solid #d4af37;
            outline: none;
            cursor: pointer;
            padding: 12px 20px;
            font-size: 16px;
            transition: 0.3s;
            border-radius: 25px;
            color: #333;
            background: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            min-width: 120px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .tab button:hover {
            background: #f0f0f0;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        .tab button.active {
            background: #e0e0e0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .tablinks.kashf-tab { background: #fff; }
        .tablinks.participation-tab { background: #fff; }
        .tablinks.input-table-tab { background: #fff; }
        .tablinks.stats-tab { background: #fff; }
        .tablinks.books-tab { background: #fff; }
        .tablinks.send-tab { background: #fff; }
        .tablinks.media-tab { background: #fff; }
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        th {
            background-color: #f2f2f2;
        }
        .student-name {
            font-weight: bold;
        }
        select, input, textarea {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .control-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .control-section input[type="text"], .control-section textarea {
            flex: 1;
            min-width: 200px;
        }
        .control-section textarea {
            height: 100px;
            resize: vertical;
        }
        .control-section select {
            width: 150px;
        }
        button {
            padding: 6px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .delete-btn { background-color: #f44336; }
        .delete-btn:hover { background-color: #da190b; }
        .delete-all-btn { background-color: #d32f2f; }
        .delete-all-btn:hover { background-color: #b71c1c; }
        .filter-btn { background-color: #2196F3; }
        .filter-btn:hover { background-color: #0b7dda; }
        .toggle-btn { background-color: #FF9800; }
        .toggle-btn:hover { background-color: #F57C00; }
        .save-btn { background-color: #673AB7; }
        .save-btn:hover { background-color: #5E35B1; }
        .save-all-btn { background-color: #3F51B5; }
        .save-all-btn:hover { background-color: #303F9F; }
        .export-btn { background-color: #28a745; }
        .export-btn:hover { background-color: #218838; }
        .whatsapp-btn { background-color: #25D366; }
        .whatsapp-btn:hover { background-color: #20BD57; }
        .upload-btn { background-color: #FF5722; }
        .upload-btn:hover { background-color: #E64A19; }
        .add-link-btn { background-color: #9C27B0; }
        .add-link-btn:hover { background-color: #7B1FA2; }
        .open-btn { background-color: #0288D1; }
        .open-btn:hover { background-color: #0277BD; }
        .checkbox-group {
            display: flex;
            flex-direction: row;
            gap: 10px;
            align-items: center;
        }
        .filter-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .move-btn {
            background-color: #2196F3;
            padding: 4px 8px;
            margin: 0 2px;
        }
        .move-btn:hover {
            background-color: #0b7dda;
        }
        tr.dragging, .media-item.dragging, .pdf-item.dragging {
            opacity: 0.5;
            background-color: #f0f0f0;
        }
        #booksIframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        .checkbox-container {
            display: flex;
            flex-direction: row;
            gap: 5px;
            align-items: center;
        }
        .checkbox-label {
            position: relative;
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
            display: inline-block;
            text-align: center;
            line-height: 20px;
            cursor: pointer;
        }
        .checkbox-label input {
            display: none;
        }
        .checkbox-label.checked::before {
            content: 'X';
            color: red;
            font-weight: bold;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .media-item, .pdf-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .media-item img, .media-item video, .media-item iframe {
            max-width: 200px;
            max-height: 200px;
            border-radius: 4px;
            cursor: pointer;
        }
        .media-item textarea, .pdf-item textarea {
            flex: 1;
            height: 60px;
            resize: vertical;
        }
        .pdf-item a {
            color: #2196F3;
            text-decoration: none;
            font-weight: bold;
        }
        .pdf-item a:hover {
            text-decoration: underline;
        }
        .pdf-item embed {
            width: 200px;
            height: 200px;
            border-radius: 4px;
        }
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .fullscreen-overlay img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        .fullscreen-overlay .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .fullscreen-overlay .close-btn:hover {
            background: #da190b;
        }
        .fullscreen-overlay .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
        }
        .fullscreen-overlay .nav-btn:hover {
            background: #0b7dda;
        }
        .fullscreen-overlay .prev-btn {
            left: 20px;
        }
        .fullscreen-overlay .next-btn {
            right: 20px;
        }
        #statsChart {
            max-width: 600px;
            margin: 20px auto;
        }
        .no-students-message {
            color: #f44336;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
        }
        .media-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .media-column {
            flex: 1;
            min-width: 300px;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .media-slide-container {
            position: relative;
            width: 100%;
            text-align: center;
        }
        .media-slide {
            display: none;
            width: 100%;
        }
        .media-slide.active {
            display: block;
        }
        .media-slide img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            cursor: pointer;
        }
        .media-slide video, .media-slide iframe {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
        }
        .media-slide textarea {
            width: 100%;
            margin-top: 10px;
        }
        .media-slide-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .media-slide-controls .delete-btn {
            background-color: #f44336;
        }
        .media-slide-controls .delete-btn:hover {
            background-color: #da190b;
        }
        .media-slide-controls .nav-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .media-slide-controls .nav-btn:hover {
            background: #0b7dda;
        }
        .media-item.video-item img, .media-item.video-item video, .media-item.video-item iframe {
            max-width: 200px;
            max-height: 200px;
            border-radius: 4px;
        }
        .video-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .batch-checkbox-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 10px 0;
        }
        .batch-checkbox-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .batch-checkbox-group label {
            font-size: 14px;
        }
        .grade-upload-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .grade-upload-section button {
            background-color: #FF9800;
        }
        .grade-upload-section button:hover {
            background-color: #F57C00;
        }
        .media-group {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .media-group-header {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>كشف المتابعة اليومي</h2>

        <div class="tab">
            <button class="tablinks kashf-tab active" onclick="openTab(event, 'kashf')">الكشف</button>
            <button class="tablinks participation-tab" onclick="openTab(event, 'participation')">المشاركة والواجبات</button>
            <button class="tablinks input-table-tab" onclick="openTab(event, 'inputTable')">جدول الإدخال</button>
            <button class="tablinks stats-tab" onclick="openTab(event, 'stats')">إحصائيات</button>
            <button class="tablinks books-tab" onclick="openTab(event, 'books')">الكتب الدراسية</button>
            <button class="tablinks send-tab" onclick="openTab(event, 'send')">إرسال</button>
            <button class="tablinks media-tab" onclick="openTab(event, 'media')">الوسائط</button>
        </div>

        <div id="kashf" class="tabcontent" style="display: block;">
            <div class="control-section">
                <input type="text" id="studentName" placeholder="اسم الطالب" onkeypress="if(event.key === 'Enter') addStudent()">
                <button onclick="addStudent()">إضافة طالب</button>
                <button class="delete-all-btn" onclick="deleteAllKashfRows()">حذف الكل</button>
                <button class="save-all-btn" onclick="saveAllStudents()">حفظ الكل</button>
            </div>
            <div class="control-section">
                <div id="multipleStudentsContainer" style="display: block;">
                    <textarea id="multipleStudents" placeholder="أدخل أسماء الطلاب (كل اسم في سطر)" onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); addMultipleStudents(); }"></textarea>
                    <button onclick="addMultipleStudents()">إضافة الطلاب دفعة واحدة</button>
                </div>
                <button class="toggle-btn" onclick="toggleMultipleStudentsInput()">إخفاء الحقل</button>
            </div>
            <div class="batch-checkbox-section">
                <div class="batch-checkbox-group">
                    <label><input type="checkbox" id="batchGrade1" onchange="updateBatchGrade(this, 'الأول متوسط')"> الأول متوسط</label>
                    <label><input type="checkbox" id="batchGrade2" onchange="updateBatchGrade(this, 'الثاني متوسط')"> الثاني متوسط</label>
                    <label><input type="checkbox" id="batchGrade3" onchange="updateBatchGrade(this, 'الثالث متوسط')"> الثالث متوسط</label>
                </div>
                <div class="batch-checkbox-group">
                    <label><input type="checkbox" id="batchSection1" onchange="updateBatchSection(this, '1')"> 1</label>
                    <label><input type="checkbox" id="batchSection2" onchange="updateBatchSection(this, '2')"> 2</label>
                    <label><input type="checkbox" id="batchSection3" onchange="updateBatchSection(this, '3')"> 3</label>
                </div>
            </div>
            <div class="filter-section">
                <button class="filter-btn" onclick="filterKashfTable()">تصفية</button>
                <select id="filterKashfGrade" onchange="updateKashfSections()">
                    <option value="">جميع الصفوف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <select id="filterKashfSection" onchange="filterKashfTable()">
                    <option value="">جميع الفصول</option>
                </select>
            </div>
            <table id="dailyTable">
                <thead>
                    <tr>
                        <th style="width: 60px;">تحريك</th>
                        <th>الاسم</th>
                        <th>الصف</th>
                        <th>الفصل</th>
                        <th>السلوك</th>
                        <th>الدرجة</th>
                        <th>حفظ</th>
                        <th>حذف</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div id="noStudentsMessage" class="no-students-message" style="display: none;">
                لا توجد أسماء تتطابق مع التصفية. حاول تغيير الصف أو الفصل.
            </div>
        </div>

        <div id="participation" class="tabcontent">
            <div class="filter-section">
                <button class="filter-btn" onclick="updateParticipationTable()">تصفية</button>
                <select id="filterParticipationGrade" onchange="updateParticipationSections()">
                    <option value="">جميع الصفوف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <select id="filterParticipationSection" onchange="updateParticipationTable()">
                    <option value="">جميع الفصول</option>
                </select>
                <button class="export-btn" onclick="exportParticipationToExcel()">تصدير إلى Excel</button>
            </div>
            <table id="participationTable">
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>م</th>
                        <th>درجة المشاركة</th>
                        <th>و</th>
                        <th>درجة الواجب</th>
                    </tr>
                </thead>
                <tbody id="participationTableBody"></tbody>
            </table>
        </div>

        <div id="inputTable" class="tabcontent">
            <div class="filter-section">
                <button class="filter-btn" onclick="filterSavedTable()">تصفية حسب الصف</button>
                <select id="filterGrade" onchange="filterSavedTable()">
                    <option value="">جميع الصفوف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <button class="export-btn" onclick="exportToExcel()">تصدير إلى Excel</button>
            </div>
            <table id="savedTable">
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>الصف</th>
                        <th>الفصل</th>
                        <th>السلوك</th>
                        <th>الدرجة</th>
                        <th>اليوم</th>
                        <th>التاريخ</th>
                        <th>ملاحظات على الطالب</th>
                        <th>حذف</th>
                    </tr>
                </thead>
                <tbody id="savedTableBody"></tbody>
            </table>
        </div>

        <div id="stats" class="tabcontent">
            <div class="control-section">
                <select id="statsGrade" onchange="updateStatsSections(); updateStatsChart()">
                    <option value="">اختر الصف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <select id="statsSection" onchange="updateStatsChart()">
                    <option value="">اختر الفصل</option>
                </select>
            </div>
            <canvas id="statsChart"></canvas>
        </div>

        <div id="books" class="tabcontent">
            <iframe id="booksIframe" src="https://ktby.net" title="الكتب الدراسية"></iframe>
        </div>

        <div id="send" class="tabcontent">
            <div class="control-section">
                <select id="sendGrade" onchange="updateSendSections()">
                    <option value="">اختر الصف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <select id="sendSection" onchange="updateFilteredStudentList()">
                    <option value="">اختر الفصل</option>
                </select>
                <select id="filteredStudents" onchange="displayStudentDetails()">
                    <option value="">اختر الطالب</option>
                </select>
            </div>
            <table id="studentDetailsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>الصف</th>
                        <th>الفصل</th>
                        <th>جميع السلوكيات</th>
                        <th>الدرجة</th>
                        <th>ملاحظات على الطالب</th>
                    </tr>
                </thead>
                <tbody id="studentDetailsBody"></tbody>
            </table>
            <div id="whatsappButton" style="display: none; margin-top: 10px;">
                <button class="whatsapp-btn" onclick="sendToWhatsApp()">إرسال عبر واتساب</button>
            </div>
        </div>

        <div id="media" class="tabcontent">
            <div class="grade-upload-section">
                <button class="upload-btn" onclick="document.getElementById('mediaUploadGrade1').click()">رفع للصف الأول متوسط</button>
                <input type="file" id="mediaUploadGrade1" accept="image/*,video/*,application/pdf" multiple style="display: none;" onchange="handleMediaUpload(event, 'الأول متوسط')">
                <button class="upload-btn" onclick="document.getElementById('mediaUploadGrade2').click()">رفع للصف الثاني متوسط</button>
                <input type="file" id="mediaUploadGrade2" accept="image/*,video/*,application/pdf" multiple style="display: none;" onchange="handleMediaUpload(event, 'الثاني متوسط')">
                <button class="upload-btn" onclick="document.getElementById('mediaUploadGrade3').click()">رفع للصف الثالث متوسط</button>
                <input type="file" id="mediaUploadGrade3" accept="image/*,video/*,application/pdf" multiple style="display: none;" onchange="handleMediaUpload(event, 'الثالث متوسط')">
            </div>
            <div class="control-section">
                <input type="text" id="mediaLink" placeholder="أدخل رابط الصورة، الفيديو، أو ملف PDF">
                <select id="mediaGradeSelect">
                    <option value="">اختر الصف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <button class="add-link-btn" onclick="addMediaFromLink()">إضافة من رابط</button>
            </div>
            <div id="mediaContainer"></div>
        </div>

        <div id="fullscreenOverlay" class="fullscreen-overlay">
            <img id="fullscreenImage" src="" alt="صورة مكبرة">
            <button class="close-btn" onclick="closeFullscreen()">إغلاق</button>
            <button class="nav-btn prev-btn" onclick="navigateImages(-1)">❮</button>
            <button class="nav-btn next-btn" onclick="navigateImages(1)">❯</button>
        </div>
    </div>

    <script>
        let students = [];
        let savedStudents = [];
        let participationData = {};
        let mediaGroups = { 'الأول متوسط': [], 'الثاني متوسط': [], 'الثالث متوسط': [] };
        let statsChart = null;
        let currentTab = 'kashf';
        let historyStack = [];
        let currentImageIndex = -1;
        let imageSources = [];
        let currentGrade = '';
        let batchGrade = '';
        let batchSection = '';

        let db;
        const dbName = "KashfDB";
        const dbVersion = 1;
        let isDbReady = false;

        // التحقق من دعم IndexedDB
        if (!window.indexedDB) {
            console.error("IndexedDB غير مدعوم في هذا المتصفح.");
            alert("هذا المتصفح لا يدعم IndexedDB. يرجى استخدام متصفح حديث مثل Chrome أو Firefox.");
        }

        // التحقق من تحميل المكتبات الخارجية
        function checkLibraries() {
            if (typeof Chart === 'undefined') {
                console.error("فشل تحميل Chart.js. يرجى التحقق من اتصال الإنترنت أو رابط CDN.");
                alert("فشل تحميل مكتبة Chart.js. بعض الوظائف مثل الإحصائيات قد لا تعمل.");
            }
            if (typeof XLSX === 'undefined') {
                console.error("فشل تحميل XLSX. يرجى التحقق من اتصال الإنترنت أو رابط CDN.");
                alert("فشل تحميل مكتبة XLSX. وظيفة التصدير إلى Excel قد لا تعمل.");
            }
        }

        function initDB() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    console.warn("IndexedDB غير مدعوم. سيتم استخدام التخزين المؤقت في الذاكرة.");
                    isDbReady = false;
                    resolve();
                    return;
                }

                const request = indexedDB.open(dbName, dbVersion);

                request.onupgradeneeded = function(event) {
                    db = event.target.result;
                    try {
                        if (!db.objectStoreNames.contains('mediaGroups')) {
                            db.createObjectStore('mediaGroups', { keyPath: 'id', autoIncrement: true });
                        }
                        if (!db.objectStoreNames.contains('students')) {
                            db.createObjectStore('students', { keyPath: 'id', autoIncrement: true });
                        }
                        if (!db.objectStoreNames.contains('savedStudents')) {
                            db.createObjectStore('savedStudents', { keyPath: 'id', autoIncrement: true });
                        }
                        if (!db.objectStoreNames.contains('participation')) {
                            db.createObjectStore('participation', { keyPath: 'id', autoIncrement: true });
                        }
                    } catch (error) {
                        console.error("Error creating object stores:", error);
                        reject(error);
                    }
                };

                request.onsuccess = function(event) {
                    db = event.target.result;
                    isDbReady = true;
                    console.log("IndexedDB تم تهيئتها بنجاح.");
                    resolve();
                };

                request.onerror = function(event) {
                    console.error("Error opening IndexedDB:", event.target.error);
                    isDbReady = false;
                    reject(event.target.error);
                };

                request.onblocked = function(event) {
                    console.error("IndexedDB blocked. Please close other tabs using the same database.");
                    isDbReady = false;
                    reject(new Error("IndexedDB blocked"));
                };
            });
        }

        window.onload = async function() {
            try {
                // التحقق من المكتبات الخارجية
                checkLibraries();

                // تهيئة قاعدة البيانات
                await initDB();

                // تحميل البيانات
                await loadAllData();

                // عرض الجدول
                renderKashfTable();
                openTab({ currentTarget: document.querySelector('.tablinks.kashf-tab') }, 'kashf');
            } catch (error) {
                console.error("Error during initialization:", error);
                alert("حدث خطأ أثناء تحميل البيانات: " + error.message + ". يمكنك الاستمرار في استخدام الصفحة، لكن بعض البيانات قد لا تكون محفوظة.");
                // عرض الجدول حتى لو فشل تحميل البيانات
                renderKashfTable();
                openTab({ currentTarget: document.querySelector('.tablinks.kashf-tab') }, 'kashf');
            }
        };

        async function loadAllData() {
            if (!isDbReady) {
                console.warn("IndexedDB غير متاح. سيتم استخدام البيانات الافتراضية.");
                return;
            }
            try {
                await loadKashfData();
                await loadSavedData();
                await loadParticipationData();
                await loadMediaData();
            } catch (error) {
                console.error("Error loading all data:", error);
                throw error;
            }
        }

        async function loadKashfData() {
            if (!isDbReady) return;
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['students'], 'readonly');
                const objectStore = transaction.objectStore('students');
                const request = objectStore.getAll();
                request.onsuccess = function(event) {
                    students = event.target.result;
                    students.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                    resolve();
                };
                request.onerror = function(event) {
                    console.error("Error loading kashf data:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function saveKashfData() {
            if (!isDbReady) return;
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['students'], 'readwrite');
                const objectStore = transaction.objectStore('students');
                objectStore.clear();
                students.forEach(student => {
                    objectStore.add(student);
                });
                transaction.oncomplete = function() {
                    resolve();
                };
                transaction.onerror = function(event) {
                    console.error("Error saving kashf data:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function loadSavedData() {
            if (!isDbReady) return;
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['savedStudents'], 'readonly');
                const objectStore = transaction.objectStore('savedStudents');
                const request = objectStore.getAll();
                request.onsuccess = function(event) {
                    savedStudents = event.target.result;
                    savedStudents.sort((a, b) => new Date(b.date) - new Date(a.date));
                    resolve();
                };
                request.onerror = function(event) {
                    console.error("Error loading saved data:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function saveSavedData() {
            if (!isDbReady) return;
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['savedStudents'], 'readwrite');
                const objectStore = transaction.objectStore('savedStudents');
                objectStore.clear();
                savedStudents.forEach(student => {
                    objectStore.add(student);
                });
                transaction.oncomplete = function() {
                    resolve();
                };
                transaction.onerror = function(event) {
                    console.error("Error saving saved data:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function loadParticipationData() {
            if (!isDbReady) return;
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['participation'], 'readonly');
                const objectStore = transaction.objectStore('participation');
                const request = objectStore.getAll();
                request.onsuccess = function(event) {
                    participationData = event.target.result.reduce((acc, item) => {
                        acc[item.studentKey] = item.data;
                        return acc;
                    }, {});
                    resolve();
                };
                request.onerror = function(event) {
                    console.error("Error loading participation data:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function saveParticipationData() {
            if (!isDbReady) return;
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['participation'], 'readwrite');
                const objectStore = transaction.objectStore('participation');
                objectStore.clear();
                Object.entries(participationData).forEach(([studentKey, data]) => {
                    objectStore.add({ studentKey, data });
                });
                transaction.oncomplete = function() {
                    resolve();
                };
                transaction.onerror = function(event) {
                    console.error("Error saving participation data:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function loadMediaData() {
            if (!isDbReady) return;
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['mediaGroups'], 'readonly');
                const objectStore = transaction.objectStore('mediaGroups');
                const request = objectStore.getAll();
                request.onsuccess = function(event) {
                    event.target.result.forEach(item => {
                        mediaGroups[item.grade] = item.media;
                    });
                    resolve();
                };
                request.onerror = function(event) {
                    console.error("Error loading media data:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function saveMediaData() {
            if (!isDbReady) return;
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['mediaGroups'], 'readwrite');
                const objectStore = transaction.objectStore('mediaGroups');
                objectStore.clear();
                Object.entries(mediaGroups).forEach(([grade, media]) => {
                    objectStore.add({ grade, media });
                });
                transaction.oncomplete = function() {
                    resolve();
                };
                transaction.onerror = function(event) {
                    console.error("Error saving media data:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
            currentTab = tabName;
            try {
                if (tabName === 'participation') {
                    updateParticipationTable();
                } else if (tabName === 'stats') {
                    updateStatsChart();
                } else if (tabName === 'send') {
                    updateSendSections();
                    updateFilteredStudentList();
                } else if (tabName === 'media') {
                    renderMediaItems();
                } else if (tabName === 'kashf') {
                    renderKashfTable();
                }
            } catch (error) {
                console.error(`Error in tab "${tabName}":`, error);
                alert("حدث خطأ في علامة التبويب: " + error.message);
            }
        }

        function updateBatchGrade(checkbox, grade) {
            const grades = ['الأول متوسط', 'الثاني متوسط', 'الثالث متوسط'];
            const gradeCheckboxes = ['batchGrade1', 'batchGrade2', 'batchGrade3'];
            
            if (checkbox.checked) {
                batchGrade = grade;
                gradeCheckboxes.forEach((id, index) => {
                    if (grades[index] !== grade) {
                        document.getElementById(id).checked = false;
                    }
                });
            } else {
                batchGrade = '';
            }
        }

        function updateBatchSection(checkbox, section) {
            const sections = ['1', '2', '3'];
            const sectionCheckboxes = ['batchSection1', 'batchSection2', 'batchSection3'];
            
            if (checkbox.checked) {
                batchSection = section;
                sectionCheckboxes.forEach((id, index) => {
                    if (sections[index] !== section) {
                        document.getElementById(id).checked = false;
                    }
                });
            } else {
                batchSection = '';
            }
        }

        function addStudent() {
            const studentName = document.getElementById('studentName').value.trim();
            if (!studentName) {
                alert('يرجى إدخال اسم الطالب');
                return;
            }
            const student = {
                name: studentName,
                grade: batchGrade,
                section: batchSection,
                behavior: '',
                score: 20
            };
            students.push(student);
            students.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            renderKashfTable();
            document.getElementById('studentName').value = '';
            saveKashfData();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
            updateParticipationTable();
        }

        function addMultipleStudents() {
            const multipleStudentsInput = document.getElementById('multipleStudents').value.trim();
            if (!multipleStudentsInput) {
                alert('يرجى إدخال أسماء الطلاب');
                return;
            }
            const studentNames = multipleStudentsInput.split('\n').map(name => name.trim()).filter(name => name);
            studentNames.forEach(name => {
                const student = {
                    name: name,
                    grade: batchGrade,
                    section: batchSection,
                    behavior: '',
                    score: 20
                };
                students.push(student);
            });
            students.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            renderKashfTable();
            document.getElementById('multipleStudents').value = '';
            saveKashfData();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
            updateParticipationTable();
        }

        function toggleMultipleStudentsInput() {
            const container = document.getElementById('multipleStudentsContainer');
            const toggleButton = document.querySelector('.toggle-btn');
            container.style.display = container.style.display === 'block' ? 'none' : 'block';
            toggleButton.textContent = container.style.display === 'block' ? 'إخفاء الحقل' : 'إظهار الحقل';
        }

        function renderKashfTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            const noStudentsMessage = document.getElementById('noStudentsMessage');
            noStudentsMessage.style.display = 'none';

            students.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <button class="move-btn" onclick="moveRowUp(${index})" ${index === 0 ? 'disabled' : ''}>↑</button>
                        <button class="move-btn" onclick="moveRowDown(${index})" ${index === students.length - 1 ? 'disabled' : ''}>↓</button>
                    </td>
                    <td class="student-name"><input type="text" value="${student.name}" onchange="updateStudent(${index}, 'name', this.value)"></td>
                    <td>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="grade_${index}" value="الأول متوسط" ${student.grade === 'الأول متوسط' ? 'checked' : ''} onchange="updateStudent(${index}, 'grade', this)"> الأول متوسط</label>
                            <label><input type="checkbox" name="grade_${index}" value="الثاني متوسط" ${student.grade === 'الثاني متوسط' ? 'checked' : ''} onchange="updateStudent(${index}, 'grade', this)"> الثاني متوسط</label>
                            <label><input type="checkbox" name="grade_${index}" value="الثالث متوسط" ${student.grade === 'الثالث متوسط' ? 'checked' : ''} onchange="updateStudent(${index}, 'grade', this)"> الثالث متوسط</label>
                        </div>
                    </td>
                    <td>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="section_${index}" value="1" ${student.section === '1' ? 'checked' : ''} onchange="updateStudent(${index}, 'section', this)"> 1</label>
                            <label><input type="checkbox" name="section_${index}" value="2" ${student.section === '2' ? 'checked' : ''} onchange="updateStudent(${index}, 'section', this)"> 2</label>
                            <label><input type="checkbox" name="section_${index}" value="3" ${student.section === '3' ? 'checked' : ''} onchange="updateStudent(${index}, 'section', this)"> 3</label>
                        </div>
                    </td>
                    <td>
                        <select onchange="updateBehavior(${index}, this.value)">
                            <option value="">اختر السلوك</option>
                            <option value="نسي الكتاب" ${student.behavior === 'نسي الكتاب' ? 'selected' : ''}>نسي الكتاب</option>
                            <option value="التحدث أثناء الدرس" ${student.behavior === 'التحدث أثناء الدرس' ? 'selected' : ''}>التحدث أثناء الدرس</option>
                            <option value="متأخر" ${student.behavior === 'متأخر' ? 'selected' : ''}>متأخر</option>
                            <option value="نائم" ${student.behavior === 'نائم' ? 'selected' : ''}>نائم</option>
                            <option value="رجوع" ${student.behavior === 'رجوع' ? 'selected' : ''}>رجوع</option>
                        </select>
                    </td>
                    <td><input type="number" value="${student.score}" min="0" max="20" onchange="updateStudent(${index}, 'score', this.value)"></td>
                    <td><button class="save-btn" onclick="saveStudent(${index})">حفظ</button></td>
                    <td><button class="delete-btn" onclick="deleteStudent(${index})">حذف</button></td>
                `;
                tableBody.appendChild(row);
            });

            if (students.length === 0) {
                noStudentsMessage.style.display = 'block';
                noStudentsMessage.textContent = 'لا توجد أسماء لعرضها. أضف طلابًا جدد.';
            }
            updateKashfSections();
        }

        function moveRowUp(index) {
            if (index > 0) {
                [students[index], students[index - 1]] = [students[index - 1], students[index]];
                renderKashfTable();
                saveKashfData();
                saveToHistory();
            }
        }

        function moveRowDown(index) {
            if (index < students.length - 1) {
                [students[index], students[index + 1]] = [students[index + 1], students[index]];
                renderKashfTable();
                saveKashfData();
                saveToHistory();
            }
        }

        function updateStudent(index, field, value) {
            if (field === 'grade' || field === 'section') {
                const checkboxes = document.getElementsByName(`${field}_${index}`);
                checkboxes.forEach(checkbox => {
                    if (checkbox !== value) checkbox.checked = false;
                });
                students[index][field] = value.checked ? value.value : '';
            } else {
                students[index][field] = value;
            }
            students.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            renderKashfTable();
            saveKashfData();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
            updateParticipationTable();
        }

        function updateBehavior(index, behavior) {
            students[index].behavior = behavior;
            if (behavior === 'رجوع') {
                students[index].score = 20;
            } else if (behavior && behavior !== '') {
                students[index].score = Math.max(0, students[index].score - 2);
            }
            renderKashfTable();
            saveKashfData();
            saveToHistory();
        }

        function saveStudent(index) {
            const student = { ...students[index] };
            const today = new Date();
            student.date = today.toLocaleDateString('ar-EG');
            student.day = today.toLocaleDateString('ar-EG', { weekday: 'long' });
            savedStudents.push(student);
            savedStudents.sort((a, b) => new Date(b.date) - new Date(a.date));
            renderSavedTable();
            saveSavedData();
            saveToHistory();
        }

        function saveAllStudents() {
            let allValid = true;
            students.forEach((student, index) => {
                if (!student.name) {
                    alert(`يرجى إدخال اسم الطالب في السطر ${index + 1}`);
                    allValid = false;
                } else if (!student.grade) {
                    alert(`يرجى اختيار الصف للطالب: ${student.name}`);
                    allValid = false;
                } else if (!student.section) {
                    alert(`يرجى اختيار الفصل للطالب: ${student.name}`);
                    allValid = false;
                } else if (!student.behavior || student.behavior === '') {
                    alert(`يرجى اختيار السلوك للطالب: ${student.name}`);
                    allValid = false;
                }
            });

            if (!allValid) return;

            students.forEach((student, index) => {
                saveStudent(index);
            });

            alert('تم حفظ جميع الطلاب بنجاح!');
        }

        function deleteStudent(index) {
            students.splice(index, 1);
            renderKashfTable();
            saveKashfData();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
            updateParticipationTable();
        }

        function deleteAllKashfRows() {
            students = [];
            renderKashfTable();
            saveKashfData();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
            updateParticipationTable();
        }

        function updateKashfSections() {
            const gradeFilter = document.getElementById('filterKashfGrade').value;
            const sections = [...new Set(students.filter(s => !gradeFilter || s.grade === gradeFilter).map(s => s.section).filter(s => s))];
            const sectionSelect = document.getElementById('filterKashfSection');
            sectionSelect.innerHTML = '<option value="">جميع الفصول</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
        }

        function filterKashfTable() {
            const gradeFilter = document.getElementById('filterKashfGrade').value;
            const sectionFilter = document.getElementById('filterKashfSection').value;
            const filteredStudents = students.filter(student => 
                (!gradeFilter || student.grade === gradeFilter) &&
                (!sectionFilter || student.section === sectionFilter)
            );
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            const noStudentsMessage = document.getElementById('noStudentsMessage');
            noStudentsMessage.style.display = 'none';

            filteredStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <button class="move-btn" onclick="moveRowUp(${students.indexOf(student)})" ${students.indexOf(student) === 0 ? 'disabled' : ''}>↑</button>
                        <button class="move-btn" onclick="moveRowDown(${students.indexOf(student)})" ${students.indexOf(student) === students.length - 1 ? 'disabled' : ''}>↓</button>
                    </td>
                    <td class="student-name"><input type="text" value="${student.name}" onchange="updateStudent(${students.indexOf(student)}, 'name', this.value)"></td>
                    <td>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="grade_${index}" value="الأول متوسط" ${student.grade === 'الأول متوسط' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'grade', this)"> الأول متوسط</label>
                            <label><input type="checkbox" name="grade_${index}" value="الثاني متوسط" ${student.grade === 'الثاني متوسط' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'grade', this)"> الثاني متوسط</label>
                            <label><input type="checkbox" name="grade_${index}" value="الثالث متوسط" ${student.grade === 'الثالث متوسط' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'grade', this)"> الثالث متوسط</label>
                        </div>
                    </td>
                    <td>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="section_${index}" value="1" ${student.section === '1' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'section', this)"> 1</label>
                            <label><input type="checkbox" name="section_${index}" value="2" ${student.section === '2' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'section', this)"> 2</label>
                            <label><input type="checkbox" name="section_${index}" value="3" ${student.section === '3' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'section', this)"> 3</label>
                        </div>
                    </td>
                    <td>
                        <select onchange="updateBehavior(${students.indexOf(student)}, this.value)">
                            <option value="">اختر السلوك</option>
                            <option value="نسي الكتاب" ${student.behavior === 'نسي الكتاب' ? 'selected' : ''}>نسي الكتاب</option>
                            <option value="التحدث أثناء الدرس" ${student.behavior === 'التحدث أثناء الدرس' ? 'selected' : ''}>التحدث أثناء الدرس</option>
                            <option value="متأخر" ${student.behavior === 'متأخر' ? 'selected' : ''}>متأخر</option>
                            <option value="نائم" ${student.behavior === 'نائم' ? 'selected' : ''}>نائم</option>
                            <option value="رجوع" ${student.behavior === 'رجوع' ? 'selected' : ''}>رجوع</option>
                        </select>
                    </td>
                    <td><input type="number" value="${student.score}" min="0" max="20" onchange="updateStudent(${students.indexOf(student)}, 'score', this.value)"></td>
                    <td><button class="save-btn" onclick="saveStudent(${students.indexOf(student)})">حفظ</button></td>
                    <td><button class="delete-btn" onclick="deleteStudent(${students.indexOf(student)})">حذف</button></td>
                `;
                tableBody.appendChild(row);
            });

            if (filteredStudents.length === 0 && (gradeFilter || sectionFilter)) {
                noStudentsMessage.style.display = 'block';
                noStudentsMessage.textContent = 'لا توجد أسماء تتطابق مع التصفية. حاول تغيير الصف أو الفصل.';
            }
        }

        function renderSavedTable() {
            const tableBody = document.getElementById('savedTableBody');
            tableBody.innerHTML = '';
            savedStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.grade}</td>
                    <td>${student.section}</td>
                    <td>${student.behavior}</td>
                    <td>${student.score}</td>
                    <td>${student.day}</td>
                    <td>${student.date}</td>
                    <td><input type="text" value="${student.notes || ''}" onchange="updateSavedStudentNotes(${index}, this.value)"></td>
                    <td><button class="delete-btn" onclick="deleteSavedStudent(${index})">حذف</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateSavedStudentNotes(index, notes) {
            savedStudents[index].notes = notes;
            saveSavedData();
            saveToHistory();
        }

        function deleteSavedStudent(index) {
            savedStudents.splice(index, 1);
            renderSavedTable();
            saveSavedData();
            saveToHistory();
        }

        function filterSavedTable() {
            const gradeFilter = document.getElementById('filterGrade').value;
            const filteredStudents = savedStudents.filter(student => !gradeFilter || student.grade === gradeFilter);
            const tableBody = document.getElementById('savedTableBody');
            tableBody.innerHTML = '';
            filteredStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.grade}</td>
                    <td>${student.section}</td>
                    <td>${student.behavior}</td>
                    <td>${student.score}</td>
                    <td>${student.day}</td>
                    <td>${student.date}</td>
                    <td><input type="text" value="${student.notes || ''}" onchange="updateSavedStudentNotes(${savedStudents.indexOf(student)}, this.value)"></td>
                    <td><button class="delete-btn" onclick="deleteSavedStudent(${savedStudents.indexOf(student)})">حذف</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function exportToExcel() {
            if (typeof XLSX === 'undefined') {
                alert("مكتبة XLSX غير متوفرة. يرجى التحقق من اتصال الإنترنت.");
                return;
            }
            const table = document.getElementById('savedTable');
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'كشف المتابعة');
            XLSX.writeFile(wb, 'كشف_المتابعة.xlsx');
        }

        function exportParticipationToExcel() {
            if (typeof XLSX === 'undefined') {
                alert("مكتبة XLSX غير متوفرة. يرجى التحقق من اتصال الإنترنت.");
                return;
            }
            const table = document.getElementById('participationTable');
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'المشاركة والواجبات');
            XLSX.writeFile(wb, 'المشاركة_والواجبات.xlsx');
        }

        function updateParticipationTable() {
            const gradeFilter = document.getElementById('filterParticipationGrade').value;
            const sectionFilter = document.getElementById('filterParticipationSection').value;
            const filteredStudents = students.filter(student => 
                (!gradeFilter || student.grade === gradeFilter) &&
                (!sectionFilter || student.section === sectionFilter)
            );
            const tableBody = document.getElementById('participationTableBody');
            tableBody.innerHTML = '';
            filteredStudents.forEach(student => {
                const studentKey = `${student.name}_${student.grade}_${student.section}`;
                if (!participationData[studentKey]) {
                    participationData[studentKey] = { participation: 0, homework: 0, participationScore: 10, homeworkScore: 10 };
                }
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>
                        <div class="checkbox-group">
                            ${Array(5).fill().map((_, i) => `
                                <label class="checkbox-label ${participationData[studentKey].participation > i ? 'checked' : ''}">
                                    <input type="checkbox" ${participationData[studentKey].participation > i ? 'checked' : ''} onchange="updateParticipation('${studentKey}', 'participation', ${i + 1}, this.checked)">
                                </label>
                            `).join('')}
                        </div>
                    </td>
                    <td><input type="number" value="${participationData[studentKey].participationScore}" min="0" max="10" onchange="updateParticipationScore('${studentKey}', 'participationScore', this.value)"></td>
                    <td>
                        <div class="checkbox-group">
                            ${Array(5).fill().map((_, i) => `
                                <label class="checkbox-label ${participationData[studentKey].homework > i ? 'checked' : ''}">
                                    <input type="checkbox" ${participationData[studentKey].homework > i ? 'checked' : ''} onchange="updateParticipation('${studentKey}', 'homework', ${i + 1}, this.checked)">
                                </label>
                            `).join('')}
                        </div>
                    </td>
                    <td><input type="number" value="${participationData[studentKey].homeworkScore}" min="0" max="10" onchange="updateParticipationScore('${studentKey}', 'homeworkScore', this.value)"></td>
                `;
                tableBody.appendChild(row);
            });
            saveParticipationData();
        }

        function updateParticipation(studentKey, field, value, checked) {
            const currentCount = participationData[studentKey][field];
            participationData[studentKey][field] = checked ? value : Math.max(0, value - 1);
            const scoreField = field === 'participation' ? 'participationScore' : 'homeworkScore';
            if (checked && participationData[studentKey][field] > currentCount) {
                participationData[studentKey][scoreField] = Math.max(0, participationData[studentKey][scoreField] - 1);
            } else if (!checked && participationData[studentKey][field] < currentCount) {
                participationData[studentKey][scoreField] = Math.min(10, participationData[studentKey][scoreField] + 1);
            }
            updateParticipationTable();
            saveParticipationData();
            saveToHistory();
        }

        function updateParticipationScore(studentKey, field, value) {
            participationData[studentKey][field] = parseInt(value) || 0;
            updateParticipationTable();
            saveParticipationData();
            saveToHistory();
        }

        function updateParticipationSections() {
            const gradeFilter = document.getElementById('filterParticipationGrade').value;
            const sections = [...new Set(students.filter(s => !gradeFilter || s.grade === gradeFilter).map(s => s.section).filter(s => s))];
            const sectionSelect = document.getElementById('filterParticipationSection');
            sectionSelect.innerHTML = '<option value="">جميع الفصول</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
            updateParticipationTable();
        }

        function updateStatsSections() {
            const gradeFilter = document.getElementById('statsGrade').value;
            const sections = [...new Set(savedStudents.filter(s => !gradeFilter || s.grade === gradeFilter).map(s => s.section).filter(s => s))];
            const sectionSelect = document.getElementById('statsSection');
            sectionSelect.innerHTML = '<option value="">اختر الفصل</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
        }

        function updateStatsChart() {
            const gradeFilter = document.getElementById('statsGrade').value;
            const sectionFilter = document.getElementById('statsSection').value;
            const filteredStudents = savedStudents.filter(student => 
                (!gradeFilter || student.grade === gradeFilter) &&
                (!sectionFilter || student.section === sectionFilter)
            );

            const behaviorCounts = {};
            filteredStudents.forEach(student => {
                if (student.behavior) {
                    behaviorCounts[student.behavior] = (behaviorCounts[student.behavior] || 0) + 1;
                }
            });

            const labels = Object.keys(behaviorCounts);
            const data = Object.values(behaviorCounts);

            if (statsChart) {
                statsChart.destroy();
            }

            if (typeof Chart === 'undefined') {
                console.error("Chart.js غير متوفر. لا يمكن عرض الإحصائيات.");
                return;
            }

            const ctx = document.getElementById('statsChart').getContext('2d');
            statsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'عدد الحالات',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateSendSections() {
            const gradeFilter = document.getElementById('sendGrade').value;
            const sections = [...new Set(students.filter(s => !gradeFilter || s.grade === gradeFilter).map(s => s.section).filter(s => s))];
            const sectionSelect = document.getElementById('sendSection');
            sectionSelect.innerHTML = '<option value="">اختر الفصل</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
            updateFilteredStudentList();
        }

        function updateFilteredStudentList() {
            const gradeFilter = document.getElementById('sendGrade').value;
            const sectionFilter = document.getElementById('sendSection').value;
            const filteredStudents = students.filter(student => 
                (!gradeFilter || student.grade === gradeFilter) &&
                (!sectionFilter || student.section === sectionFilter)
            );
            const studentSelect = document.getElementById('filteredStudents');
            studentSelect.innerHTML = '<option value="">اختر الطالب</option>';
            filteredStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.name;
                option.textContent = student.name;
                studentSelect.appendChild(option);
            });
        }

        function displayStudentDetails() {
            const studentName = document.getElementById('filteredStudents').value;
            if (!studentName) {
                document.getElementById('studentDetailsTable').style.display = 'none';
                document.getElementById('whatsappButton').style.display = 'none';
                return;
            }

            const studentRecords = savedStudents.filter(s => s.name === studentName);
            const tableBody = document.getElementById('studentDetailsBody');
            tableBody.innerHTML = '';
            studentRecords.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.grade}</td>
                    <td>${student.section}</td>
                    <td>${student.behavior || 'لا يوجد'}</td>
                    <td>${student.score}</td>
                    <td>${student.notes || 'لا يوجد'}</td>
                `;
                tableBody.appendChild(row);
            });

            document.getElementById('studentDetailsTable').style.display = 'block';
            document.getElementById('whatsappButton').style.display = 'block';
        }

        function sendToWhatsApp() {
            const studentName = document.getElementById('filteredStudents').value;
            if (!studentName) {
                alert('يرجى اختيار طالب أولاً');
                return;
            }

            const studentRecords = savedStudents.filter(s => s.name === studentName);
            let message = `تفاصيل الطالب: ${studentName}\n\n`;
            studentRecords.forEach(record => {
                message += `التاريخ: ${record.date} - اليوم: ${record.day}\n`;
                message += `السلوك: ${record.behavior || 'لا يوجد'} - الدرجة: ${record.score}\n`;
                message += `الملاحظات: ${record.notes || 'لا يوجد'}\n\n`;
            });

            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function handleMediaUpload(event, grade) {
            const files = event.target.files;
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const mediaItem = {
                        type: file.type.startsWith('image') ? 'image' : file.type.startsWith('video') ? 'video' : 'pdf',
                        src: e.target.result,
                        name: file.name,
                        notes: ''
                    };
                    mediaGroups[grade].push(mediaItem);
                    saveMediaData();
                    renderMediaItems();
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        function addMediaFromLink() {
            const link = document.getElementById('mediaLink').value.trim();
            const grade = document.getElementById('mediaGradeSelect').value;
            if (!link || !grade) {
                alert('يرجى إدخال رابط واختيار صف');
                return;
            }

            const mediaItem = {
                type: link.match(/\.(jpg|jpeg|png|gif)$/i) ? 'image' :
                      link.match(/\.(mp4|webm|ogg)$/i) ? 'video' :
                      link.match(/\.(pdf)$/i) ? 'pdf' : 'unknown',
                src: link,
                name: link.split('/').pop(),
                notes: ''
            };
            if (mediaItem.type !== 'unknown') {
                mediaGroups[grade].push(mediaItem);
                saveMediaData();
                renderMediaItems();
                document.getElementById('mediaLink').value = '';
            } else {
                alert('رابط غير مدعوم. يرجى استخدام رابط لصورة، فيديو، أو ملف PDF');
            }
        }

        function renderMediaItems() {
            const container = document.getElementById('mediaContainer');
            container.innerHTML = '';
            Object.entries(mediaGroups).forEach(([grade, mediaList]) => {
                if (mediaList.length > 0) {
                    const group = document.createElement('div');
                    group.className = 'media-group';
                    group.innerHTML = `<div class="media-group-header">${grade}</div>`;
                    const mediaColumn = document.createElement('div');
                    mediaColumn.className = 'media-column';
                    mediaList.forEach((item, index) => {
                        const mediaItem = document.createElement('div');
                        mediaItem.className = 'media-item';
                        mediaItem.draggable = true;
                        mediaItem.ondragstart = function(e) { e.dataTransfer.setData('text/plain', `${grade},${index}`); };
                        mediaItem.ondragover = function(e) { e.preventDefault(); };
                        mediaItem.ondrop = function(e) {
                            e.preventDefault();
                            const [dragGrade, dragIndex] = e.dataTransfer.getData('text').split(',');
                            if (dragGrade === grade) {
                                const draggedItem = mediaGroups[dragGrade][dragIndex];
                                mediaGroups[dragGrade].splice(dragIndex, 1);
                                mediaGroups[grade].splice(index, 0, draggedItem);
                                saveMediaData();
                                renderMediaItems();
                            }
                        };
                        let mediaContent = '';
                        if (item.type === 'image') {
                            mediaContent = `<img src="${item.src}" onclick="openFullscreen('${item.src}', ${index}, '${grade}')">`;
                        } else if (item.type === 'video') {
                            mediaContent = `<video controls><source src="${item.src}" type="video/mp4">Your browser does not support the video tag.</video>`;
                        } else if (item.type === 'pdf') {
                            mediaContent = `<embed src="${item.src}">`;
                        }
                        mediaItem.innerHTML = `
                            ${mediaContent}
                            <textarea placeholder="ملاحظات" onchange="updateMediaNotes('${grade}', ${index}, this.value)">${item.notes || ''}</textarea>
                            <button class="delete-btn" onclick="deleteMediaItem('${grade}', ${index})">حذف</button>
                        `;
                        mediaColumn.appendChild(mediaItem);
                    });
                    group.appendChild(mediaColumn);
                    container.appendChild(group);
                }
            });
        }

        function updateMediaNotes(grade, index, notes) {
            mediaGroups[grade][index].notes = notes;
            saveMediaData();
        }

        function deleteMediaItem(grade, index) {
            mediaGroups[grade].splice(index, 1);
            saveMediaData();
            renderMediaItems();
        }

        function openFullscreen(src, index, grade) {
            const overlay = document.getElementById('fullscreenOverlay');
            const fullscreenImage = document.getElementById('fullscreenImage');
            imageSources = mediaGroups[grade].filter(item => item.type === 'image').map(item => item.src);
            currentImageIndex = imageSources.indexOf(src);
            fullscreenImage.src = src;
            overlay.style.display = 'flex';
        }

        function closeFullscreen() {
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.style.display = 'none';
        }

        function navigateImages(direction) {
            currentImageIndex += direction;
            if (currentImageIndex >= imageSources.length) currentImageIndex = 0;
            if (currentImageIndex < 0) currentImageIndex = imageSources.length - 1;
            document.getElementById('fullscreenImage').src = imageSources[currentImageIndex];
        }

        function saveToHistory() {
            historyStack.push(JSON.stringify({ students, savedStudents, participationData, mediaGroups }));
            if (historyStack.length > 10) historyStack.shift();
        }
    </script>
</body>
</html>
