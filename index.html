<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>كشف المتابعة اليومي</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .tab {
            overflow: hidden;
            background-color: #f1f1f1;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 5px;
            border-radius: 8px;
        }
        .tab button {
            flex: 0 0 auto;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 12px 20px;
            font-size: 16px;
            transition: 0.3s;
            border-radius: 5px;
            color: white;
            min-width: 120px;
            text-align: center;
        }
        .tab button:hover {
            opacity: 0.9;
        }
        .tab button.active {
            opacity: 0.7;
        }
        .tablinks.kashf-tab { background-color: #42A5F5; }
        .tablinks.participation-tab { background-color: #AB47BC; }
        .tablinks.input-table-tab { background-color: #4DD0E1; }
        .tablinks.stats-tab { background-color: #FFCA28; }
        .tablinks.books-tab { background-color: #66BB6A; }
        .tablinks.send-tab { background-color: #26A69A; }
        .tablinks.media-tab { background-color: #EF5350; }
        .tablinks.pdf-tab { background-color: #F06292; }
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        th {
            background-color: #f2f2f2;
        }
        .student-name {
            font-weight: bold;
        }
        select, input, textarea {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .control-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .control-section input[type="text"], .control-section textarea {
            flex: 1;
            min-width: 200px;
        }
        .control-section textarea {
            height: 100px;
            resize: vertical;
        }
        .control-section select {
            width: 150px;
        }
        button {
            padding: 6px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .delete-btn { background-color: #f44336; }
        .delete-btn:hover { background-color: #da190b; }
        .delete-all-btn { background-color: #d32f2f; }
        .delete-all-btn:hover { background-color: #b71c1c; }
        .filter-btn { background-color: #2196F3; }
        .filter-btn:hover { background-color: #0b7dda; }
        .toggle-btn { background-color: #FF9800; }
        .toggle-btn:hover { background-color: #F57C00; }
        .save-btn { background-color: #673AB7; }
        .save-btn:hover { background-color: #5E35B1; }
        .save-all-btn { background-color: #3F51B5; }
        .save-all-btn:hover { background-color: #303F9F; }
        .export-btn { background-color: #28a745; }
        .export-btn:hover { background-color: #218838; }
        .whatsapp-btn { background-color: #25D366; }
        .whatsapp-btn:hover { background-color: #20BD57; }
        .upload-btn { background-color: #FF5722; }
        .upload-btn:hover { background-color: #E64A19; }
        .add-link-btn { background-color: #9C27B0; }
        .add-link-btn:hover { background-color: #7B1FA2; }
        .open-btn { background-color: #0288D1; }
        .open-btn:hover { background-color: #0277BD; }
        .checkbox-group {
            display: flex;
            flex-direction: row;
            gap: 10px;
            align-items: center;
        }
        .filter-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .move-btn {
            background-color: #2196F3;
            padding: 4px 8px;
            margin: 0 2px;
        }
        .move-btn:hover {
            background-color: #0b7dda;
        }
        tr.dragging, .media-item.dragging, .pdf-item.dragging {
            opacity: 0.5;
            background-color: #f0f0f0;
        }
        #booksIframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        .checkbox-container {
            display: flex;
            flex-direction: row;
            gap: 5px;
            align-items: center;
        }
        .checkbox-label {
            position: relative;
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
            display: inline-block;
            text-align: center;
            line-height: 20px;
            cursor: pointer;
        }
        .checkbox-label input {
            display: none;
        }
        .checkbox-label.checked::before {
            content: 'X';
            color: red;
            font-weight: bold;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .media-item, .pdf-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .media-item img, .media-item video, .media-item iframe {
            max-width: 200px;
            max-height: 200px;
            border-radius: 4px;
            cursor: pointer;
        }
        .media-item textarea, .pdf-item textarea {
            flex: 1;
            height: 60px;
            resize: vertical;
        }
        .pdf-item a {
            color: #2196F3;
            text-decoration: none;
            font-weight: bold;
        }
        .pdf-item a:hover {
            text-decoration: underline;
        }
        .pdf-item embed {
            width: 200px;
            height: 200px;
            border-radius: 4px;
        }
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .fullscreen-overlay img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        .fullscreen-overlay .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .fullscreen-overlay .close-btn:hover {
            background: #da190b;
        }
        .fullscreen-overlay .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
        }
        .fullscreen-overlay .nav-btn:hover {
            background: #0b7dda;
        }
        .fullscreen-overlay .prev-btn {
            left: 20px;
        }
        .fullscreen-overlay .next-btn {
            right: 20px;
        }
        #statsChart {
            max-width: 600px;
            margin: 20px auto;
        }
        .no-students-message {
            color: #f44336;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
        }
        .media-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .media-column {
            flex: 1;
            min-width: 300px;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .media-slide-container {
            position: relative;
            width: 100%;
            text-align: center;
        }
        .media-slide {
            display: none;
            width: 100%;
        }
        .media-slide.active {
            display: block;
        }
        .media-slide img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            cursor: pointer;
        }
        .media-slide textarea {
            width: 100%;
            margin-top: 10px;
        }
        .media-slide-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .media-slide-controls .delete-btn {
            background-color: #f44336;
        }
        .media-slide-controls .delete-btn:hover {
            background-color: #da190b;
        }
        .media-slide-controls .nav-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .media-slide-controls .nav-btn:hover {
            background: #0b7dda;
        }
        .media-item.video-item img, .media-item.video-item video, .media-item.video-item iframe {
            max-width: 200px;
            max-height: 200px;
            border-radius: 4px;
        }
        .video-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .batch-checkbox-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 10px 0;
        }
        .batch-checkbox-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .batch-checkbox-group label {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>كشف المتابعة اليومي</h2>

        <div class="tab">
            <button class="tablinks kashf-tab active" onclick="openTab(event, 'kashf')">الكشف</button>
            <button class="tablinks participation-tab" onclick="openTab(event, 'participation')">المشاركة والواجبات</button>
            <button class="tablinks input-table-tab" onclick="openTab(event, 'inputTable')">جدول الإدخال</button>
            <button class="tablinks stats-tab" onclick="openTab(event, 'stats')">إحصائيات</button>
            <button class="tablinks books-tab" onclick="openTab(event, 'books')">الكتب الدراسية</button>
            <button class="tablinks send-tab" onclick="openTab(event, 'send')">إرسال</button>
            <button class="tablinks media-tab" onclick="openTab(event, 'media')">الفيديو والصور</button>
            <button class="tablinks pdf-tab" onclick="openTab(event, 'pdf')">ملفات PDF</button>
        </div>

        <div id="kashf" class="tabcontent" style="display: block;">
            <div class="control-section">
                <input type="text" id="studentName" placeholder="اسم الطالب" onkeypress="if(event.key === 'Enter') addStudent()">
                <button onclick="addStudent()">إضافة طالب</button>
                <button class="delete-all-btn" onclick="deleteAllKashfRows()">حذف الكل</button>
                <button class="save-all-btn" onclick="saveAllStudents()">حفظ الكل</button>
            </div>
            <div class="control-section">
                <div id="multipleStudentsContainer" style="display: block;">
                    <textarea id="multipleStudents" placeholder="أدخل أسماء الطلاب (كل اسم في سطر)" onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); addMultipleStudents(); }"></textarea>
                    <button onclick="addMultipleStudents()">إضافة الطلاب دفعة واحدة</button>
                </div>
                <button class="toggle-btn" onclick="toggleMultipleStudentsInput()">إخفاء الحقل</button>
            </div>
            <div class="batch-checkbox-section">
                <div class="batch-checkbox-group">
                    <label><input type="checkbox" id="batchGrade1" onchange="updateBatchGrade(this, 'الأول متوسط')"> الأول متوسط</label>
                    <label><input type="checkbox" id="batchGrade2" onchange="updateBatchGrade(this, 'الثاني متوسط')"> الثاني متوسط</label>
                    <label><input type="checkbox" id="batchGrade3" onchange="updateBatchGrade(this, 'الثالث متوسط')"> الثالث متوسط</label>
                </div>
                <div class="batch-checkbox-group">
                    <label><input type="checkbox" id="batchSection1" onchange="updateBatchSection(this, '1')"> 1</label>
                    <label><input type="checkbox" id="batchSection2" onchange="updateBatchSection(this, '2')"> 2</label>
                    <label><input type="checkbox" id="batchSection3" onchange="updateBatchSection(this, '3')"> 3</label>
                </div>
            </div>
            <div class="filter-section">
                <button class="filter-btn" onclick="filterKashfTable()">تصفية</button>
                <select id="filterKashfGrade" onchange="updateKashfSections()">
                    <option value="">جميع الصفوف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <select id="filterKashfSection" onchange="filterKashfTable()">
                    <option value="">جميع الفصول</option>
                </select>
            </div>
            <table id="dailyTable">
                <thead>
                    <tr>
                        <th style="width: 60px;">تحريك</th>
                        <th>الاسم</th>
                        <th>الصف</th>
                        <th>الفصل</th>
                        <th>السلوك</th>
                        <th>الدرجة</th>
                        <th>حفظ</th>
                        <th>حذف</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div id="noStudentsMessage" class="no-students-message" style="display: none;">
                لا توجد أسماء تتطابق مع التصفية. حاول تغيير الصف أو الفصل.
            </div>
        </div>

        <div id="participation" class="tabcontent">
            <div class="filter-section">
                <button class="filter-btn" onclick="updateParticipationTable()">تصفية</button>
                <select id="filterParticipationGrade" onchange="updateParticipationSections()">
                    <option value="">جميع الصفوف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <select id="filterParticipationSection" onchange="updateParticipationTable()">
                    <option value="">جميع الفصول</option>
                </select>
                <button class="export-btn" onclick="exportParticipationToExcel()">تصدير إلى Excel</button>
            </div>
            <table id="participationTable">
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>م</th>
                        <th>درجة المشاركة</th>
                        <th>و</th>
                        <th>درجة الواجب</th>
                    </tr>
                </thead>
                <tbody id="participationTableBody"></tbody>
            </table>
        </div>

        <div id="inputTable" class="tabcontent">
            <div class="filter-section">
                <button class="filter-btn" onclick="filterSavedTable()">تصفية حسب الصف</button>
                <select id="filterGrade" onchange="filterSavedTable()">
                    <option value="">جميع الصفوف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <button class="export-btn" onclick="exportToExcel()">تصدير إلى Excel</button>
            </div>
            <table id="savedTable">
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>الصف</th>
                        <th>الفصل</th>
                        <th>السلوك</th>
                        <th>الدرجة</th>
                        <th>اليوم</th>
                        <th>التاريخ</th>
                        <th>ملاحظات على الطالب</th>
                        <th>حذف</th>
                    </tr>
                </thead>
                <tbody id="savedTableBody"></tbody>
            </table>
        </div>

        <div id="stats" class="tabcontent">
            <div class="control-section">
                <select id="statsGrade" onchange="updateStatsSections(); updateStatsChart()">
                    <option value="">اختر الصف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <select id="statsSection" onchange="updateStatsChart()">
                    <option value="">اختر الفصل</option>
                </select>
            </div>
            <canvas id="statsChart"></canvas>
        </div>

        <div id="books" class="tabcontent">
            <iframe id="booksIframe" src="https://ktby.net" title="الكتب الدراسية"></iframe>
        </div>

        <div id="send" class="tabcontent">
            <div class="control-section">
                <select id="sendGrade" onchange="updateSendSections()">
                    <option value="">اختر الصف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <select id="sendSection" onchange="updateFilteredStudentList()">
                    <option value="">اختر الفصل</option>
                </select>
                <select id="filteredStudents" onchange="displayStudentDetails()">
                    <option value="">اختر الطالب</option>
                </select>
            </div>
            <table id="studentDetailsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>الصف</th>
                        <th>الفصل</th>
                        <th>جميع السلوكيات</th>
                        <th>الدرجة</th>
                        <th>ملاحظات على الطالب</th>
                    </tr>
                </thead>
                <tbody id="studentDetailsBody"></tbody>
            </table>
            <div id="whatsappButton" style="display: none; margin-top: 10px;">
                <button NOLINKIFY class="whatsapp-btn" onclick="sendToWhatsApp()">إرسال عبر واتساب</button>
            </div>
        </div>

        <div id="media" class="tabcontent">
            <div class="control-section">
                <input type="file" id="mediaUpload" accept="image/*,video/*" multiple style="display: none;" onchange="handleFileUpload(event)">
                <button class="upload-btn" onclick="document.getElementById('mediaUpload').click()">رفع صورة أو فيديو</button>
                <input type="text" id="mediaLink" placeholder="أدخل رابط الصورة أو الفيديو (مثل يوتيوب)">
                <button class="add-link-btn" onclick="addMediaFromLink()">إضافة من رابط</button>
            </div>
            <div id="mediaContainer" class="media-container"></div>
            <div id="videoContainer" class="video-container"></div>
        </div>

        <div id="pdf" class="tabcontent">
            <div class="control-section">
                <input type="file" id="pdfUpload" accept="application/pdf" multiple style="display: none;" onchange="handlePDFUpload(event)">
                <button class="upload-btn" onclick="document.getElementById('pdfUpload').click()">رفع ملف PDF</button>
                <input type="text" id="pdfLink" placeholder="أدخل رابط ملف PDF">
                <button class="add-link-btn" onclick="addPDFFromLink()">إضافة من رابط</button>
            </div>
            <div id="pdfContainer"></div>
        </div>

        <div id="fullscreenOverlay" class="fullscreen-overlay">
            <img id="fullscreenImage" src="" alt="صورة مكبرة">
            <button class="close-btn" onclick="closeFullscreen()">إغلاق</button>
            <button class="nav-btn prev-btn" onclick="navigateImages(-1)">❮</button>
            <button class="nav-btn next-btn" onclick="navigateImages(1)">❯</button>
        </div>
    </div>

    <script>
        let students = [];
        let savedStudents = [];
        let participationData = {};
        let mediaGroups = [];
        let videoItems = [];
        let pdfItems = [];
        let statsChart = null;
        let currentTab = 'kashf';
        let historyStack = [];
        let currentImageIndex = -1;
        let imageSources = [];
        let currentGroupIndex = -1;
        let batchGrade = '';
        let batchSection = '';

        let db;
        const dbName = "KashfDB";
        const dbVersion = 1;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);

                request.onupgradeneeded = function(event) {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('mediaGroups')) {
                        db.createObjectStore('mediaGroups', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('videoItems')) {
                        db.createObjectStore('videoItems', { keyPath: 'id', autoIncrement: true });
                    }
                };

                request.onsuccess = function(event) {
                    db = event.target.result;
                    resolve();
                };

                request.onerror = function(event) {
                    console.error("Error opening IndexedDB:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        window.onload = async function() {
            try {
                await initDB();
                await loadAllData();
                renderKashfTable();
                openTab({ currentTarget: document.querySelector('.tablinks.kashf-tab') }, 'kashf');
            } catch (error) {
                console.error("Error during initialization:", error);
                alert("حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.");
            }
        };

        async function loadAllData() {
            await loadKashfData();
            await loadSavedData();
            await loadParticipationData();
            await loadMediaData();
            await loadVideoData();
            await loadPDFData();
        }

        function openTab(evt, tabName) {
            console.log("Opening tab:", tabName);
            const tabcontent = document.getElementsByClassName("tabcontent");
            if (tabcontent.length === 0) {
                console.error("No elements with class 'tabcontent' found.");
                return;
            }
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            const tablinks = document.getElementsByClassName("tablinks");
            if (tablinks.length === 0) {
                console.error("No elements with class 'tablinks' found.");
                return;
            }
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
            currentTab = tabName;
            try {
                if (tabName === 'participation') {
                    updateParticipationTable();
                } else if (tabName === 'stats') {
                    updateStatsChart();
                } else if (tabName === 'send') {
                    updateSendSections();
                    updateFilteredStudentList();
                } else if (tabName === 'media') {
                    renderMediaItems();
                    renderVideoItems();
                } else if (tabName === 'pdf') {
                    renderPDFItems();
                } else if (tabName === 'kashf') {
                    renderKashfTable();
                }
            } catch (error) {
                console.error(`Error in tab "${tabName}":`, error);
            }
        }

        function updateBatchGrade(checkbox, grade) {
            const grades = ['الأول متوسط', 'الثاني متوسط', 'الثالث متوسط'];
            const gradeCheckboxes = ['batchGrade1', 'batchGrade2', 'batchGrade3'];
            
            if (checkbox.checked) {
                batchGrade = grade;
                gradeCheckboxes.forEach((id, index) => {
                    if (grades[index] !== grade) {
                        document.getElementById(id).checked = false;
                    }
                });
            } else {
                batchGrade = '';
            }
        }

        function updateBatchSection(checkbox, section) {
            const sections = ['1', '2', '3'];
            const sectionCheckboxes = ['batchSection1', 'batchSection2', 'batchSection3'];
            
            if (checkbox.checked) {
                batchSection = section;
                sectionCheckboxes.forEach((id, index) => {
                    if (sections[index] !== section) {
                        document.getElementById(id).checked = false;
                    }
                });
            } else {
                batchSection = '';
            }
        }

        function addStudent() {
            const studentName = document.getElementById('studentName').value.trim();
            if (!studentName) {
                alert('يرجى إدخال اسم الطالب');
                return;
            }
            const student = {
                name: studentName,
                grade: batchGrade,
                section: batchSection,
                behavior: '',
                score: 20
            };
            students.push(student);
            students.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            renderKashfTable();
            document.getElementById('studentName').value = '';
            saveKashfData();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
            updateParticipationTable();
        }

        function addMultipleStudents() {
            const multipleStudentsInput = document.getElementById('multipleStudents').value.trim();
            if (!multipleStudentsInput) {
                alert('يرجى إدخال أسماء الطلاب');
                return;
            }
            const studentNames = multipleStudentsInput.split('\n').map(name => name.trim()).filter(name => name);
            studentNames.forEach(name => {
                const student = {
                    name: name,
                    grade: batchGrade,
                    section: batchSection,
                    behavior: '',
                    score: 20
                };
                students.push(student);
            });
            students.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            renderKashfTable();
            document.getElementById('multipleStudents').value = '';
            saveKashfData();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
            updateParticipationTable();
        }

        function toggleMultipleStudentsInput() {
            const container = document.getElementById('multipleStudentsContainer');
            const toggleButton = document.querySelector('.toggle-btn');
            container.style.display = container.style.display === 'block' ? 'none' : 'block';
            toggleButton.textContent = container.style.display === 'block' ? 'إخفاء الحقل' : 'إظهار الحقل';
        }

        function renderKashfTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            const noStudentsMessage = document.getElementById('noStudentsMessage');
            noStudentsMessage.style.display = 'none';

            students.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <button class="move-btn" onclick="moveRowUp(${index})" ${index === 0 ? 'disabled' : ''}>↑</button>
                        <button class="move-btn" onclick="moveRowDown(${index})" ${index === students.length - 1 ? 'disabled' : ''}>↓</button>
                    </td>
                    <td class="student-name"><input type="text" value="${student.name}" onchange="updateStudent(${index}, 'name', this.value)"></td>
                    <td>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="grade_${index}" value="الأول متوسط" ${student.grade === 'الأول متوسط' ? 'checked' : ''} onchange="updateStudent(${index}, 'grade', this)"> الأول متوسط</label>
                            <label><input type="checkbox" name="grade_${index}" value="الثاني متوسط" ${student.grade === 'الثاني متوسط' ? 'checked' : ''} onchange="updateStudent(${index}, 'grade', this)"> الثاني متوسط</label>
                            <label><input type="checkbox" name="grade_${index}" value="الثالث متوسط" ${student.grade === 'الثالث متوسط' ? 'checked' : ''} onchange="updateStudent(${index}, 'grade', this)"> الثالث متوسط</label>
                        </div>
                    </td>
                    <td>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="section_${index}" value="1" ${student.section === '1' ? 'checked' : ''} onchange="updateStudent(${index}, 'section', this)"> 1</label>
                            <label><input type="checkbox" name="section_${index}" value="2" ${student.section === '2' ? 'checked' : ''} onchange="updateStudent(${index}, 'section', this)"> 2</label>
                            <label><input type="checkbox" name="section_${index}" value="3" ${student.section === '3' ? 'checked' : ''} onchange="updateStudent(${index}, 'section', this)"> 3</label>
                        </div>
                    </td>
                    <td>
                        <select onchange="updateBehavior(${index}, this.value)">
                            <option value="">اختر السلوك</option>
                            <option value="نسي الكتاب" ${student.behavior === 'نسي الكتاب' ? 'selected' : ''}>نسي الكتاب</option>
                            <option value="التحدث أثناء الدرس" ${student.behavior === 'التحدث أثناء الدرس' ? 'selected' : ''}>التحدث أثناء الدرس</option>
                            <option value="متأخر" ${student.behavior === 'متأخر' ? 'selected' : ''}>متأخر</option>
                            <option value="نائم" ${student.behavior === 'نائم' ? 'selected' : ''}>نائم</option>
                            <option value="رجوع" ${student.behavior === 'رجوع' ? 'selected' : ''}>رجوع</option>
                        </select>
                    </td>
                    <td><input type="number" value="${student.score}" min="0" max="20" onchange="updateStudent(${index}, 'score', this.value)"></td>
                    <td><button class="save-btn" onclick="saveStudent(${index})">حفظ</button></td>
                    <td><button class="delete-btn" onclick="deleteStudent(${index})">حذف</button></td>
                `;
                tableBody.appendChild(row);
            });

            if (students.length === 0) {
                noStudentsMessage.style.display = 'block';
                noStudentsMessage.textContent = 'لا توجد أسماء لعرضها. أضف طلابًا جدد.';
            }
            updateKashfSections();
        }

        function moveRowUp(index) {
            if (index > 0) {
                [students[index], students[index - 1]] = [students[index - 1], students[index]];
                renderKashfTable();
                saveKashfData();
                saveToHistory();
            }
        }

        function moveRowDown(index) {
            if (index < students.length - 1) {
                [students[index], students[index + 1]] = [students[index + 1], students[index]];
                renderKashfTable();
                saveKashfData();
                saveToHistory();
            }
        }

        function updateStudent(index, field, value) {
            if (field === 'grade' || field === 'section') {
                const checkboxes = document.getElementsByName(`${field}_${index}`);
                checkboxes.forEach(checkbox => {
                    if (checkbox !== value) checkbox.checked = false;
                });
                students[index][field] = value.checked ? value.value : '';
            } else {
                students[index][field] = value;
            }
            students.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            renderKashfTable();
            saveKashfData();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
            updateParticipationTable();
        }

        function updateBehavior(index, behavior) {
            students[index].behavior = behavior;
            if (behavior === 'رجوع') {
                students[index].score = 20;
            } else if (behavior && behavior !== '') {
                students[index].score = Math.max(0, students[index].score - 2);
            }
            renderKashfTable();
            saveKashfData();
            saveToHistory();
        }

        function saveStudent(index) {
            const student = { ...students[index] };
            const today = new Date();
            student.date = today.toLocaleDateString('ar-EG');
            student.day = today.toLocaleDateString('ar-EG', { weekday: 'long' });
            savedStudents.push(student);
            savedStudents.sort((a, b) => new Date(b.date) - new Date(a.date));
            renderSavedTable();
            saveSavedData();
            saveToHistory();
        }

        function saveAllStudents() {
            let allValid = true;
            students.forEach((student, index) => {
                if (!student.name) {
                    alert(`يرجى إدخال اسم الطالب في السطر ${index + 1}`);
                    allValid = false;
                } else if (!student.grade) {
                    alert(`يرجى اختيار الصف للطالب: ${student.name}`);
                    allValid = false;
                } else if (!student.section) {
                    alert(`يرجى اختيار الفصل للطالب: ${student.name}`);
                    allValid = false;
                } else if (!student.behavior || student.behavior === '') {
                    alert(`يرجى اختيار السلوك للطالب: ${student.name}`);
                    allValid = false;
                }
            });

            if (!allValid) return;

            students.forEach((student, index) => {
                saveStudent(index);
            });

            alert('تم حفظ جميع الطلاب بنجاح!');
        }

        function deleteStudent(index) {
            students.splice(index, 1);
            renderKashfTable();
            saveKashfData();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
            updateParticipationTable();
        }

        function deleteAllKashfRows() {
            students = [];
            renderKashfTable();
            saveKashfData();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
            updateParticipationTable();
        }

        function updateKashfSections() {
            const gradeFilter = document.getElementById('filterKashfGrade').value;
            const sections = [...new Set(students.filter(s => !gradeFilter || s.grade === gradeFilter).map(s => s.section).filter(s => s))];
            const sectionSelect = document.getElementById('filterKashfSection');
            sectionSelect.innerHTML = '<option value="">جميع الفصول</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
        }

        function filterKashfTable() {
            const gradeFilter = document.getElementById('filterKashfGrade').value;
            const sectionFilter = document.getElementById('filterKashfSection').value;
            const filteredStudents = students.filter(student => 
                (!gradeFilter || student.grade === gradeFilter) &&
                (!sectionFilter || student.section === sectionFilter)
            );
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            const noStudentsMessage = document.getElementById('noStudentsMessage');
            noStudentsMessage.style.display = 'none';

            filteredStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <button class="move-btn" onclick="moveRowUp(${students.indexOf(student)})" ${students.indexOf(student) === 0 ? 'disabled' : ''}>↑</button>
                        <button class="move-btn" onclick="moveRowDown(${students.indexOf(student)})" ${students.indexOf(student) === students.length - 1 ? 'disabled' : ''}>↓</button>
                    </td>
                    <td class="student-name"><input type="text" value="${student.name}" onchange="updateStudent(${students.indexOf(student)}, 'name', this.value)"></td>
                    <td>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="grade_${index}" value="الأول متوسط" ${student.grade === 'الأول متوسط' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'grade', this)"> الأول متوسط</label>
                            <label><input type="checkbox" name="grade_${index}" value="الثاني متوسط" ${student.grade === 'الثاني متوسط' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'grade', this)"> الثاني متوسط</label>
                            <label><input type="checkbox" name="grade_${index}" value="الثالث متوسط" ${student.grade === 'الثالث متوسط' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'grade', this)"> الثالث متوسط</label>
                        </div>
                    </td>
                    <td>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="section_${index}" value="1" ${student.section === '1' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'section', this)"> 1</label>
                            <label><input type="checkbox" name="section_${index}" value="2" ${student.section === '2' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'section', this)"> 2</label>
                            <label><input type="checkbox" name="section_${index}" value="3" ${student.section === '3' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'section', this)"> 3</label>
                        </div>
                    </td>
                    <td>
                        <select onchange="updateBehavior(${students.indexOf(student)}, this.value)">
                            <option value="">اختر السلوك</option>
                            <option value="نسي الكتاب" ${student.behavior === 'نسي الكتاب' ? 'selected' : ''}>نسي الكتاب</option>
                            <option value="التحدث أثناء الدرس" ${student.behavior === 'التحدث أثناء الدرس' ? 'selected' : ''}>التحدث أثناء الدرس</option>
                            <option value="متأخر" ${student.behavior === 'متأخر' ? 'selected' : ''}>متأخر</option>
                            <option value="نائم" ${student.behavior === 'نائم' ? 'selected' : ''}>نائم</option>
                            <option value="رجوع" ${student.behavior === 'رجوع' ? 'selected' : ''}>رجوع</option>
                        </select>
                    </td>
                    <td><input type="number" value="${student.score}" min="0" max="20" onchange="updateStudent(${students.indexOf(student)}, 'score', this.value)"></td>
                    <td><button class="save-btn" onclick="saveStudent(${students.indexOf(student)})">حفظ</button></td>
                    <td><button class="delete-btn" onclick="deleteStudent(${students.indexOf(student)})">حذف</button></td>
                `;
                tableBody.appendChild(row);
            });

            if (filteredStudents.length === 0 && (gradeFilter || sectionFilter)) {
                noStudentsMessage.style.display = 'block';
                noStudentsMessage.textContent = 'لا توجد أسماء تتطابق مع التصفية. حاول تغيير الصف أو الفصل.';
            }
        }

        function renderSavedTable() {
            const tableBody = document.getElementById('savedTableBody');
            tableBody.innerHTML = '';
            savedStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.grade}</td>
                    <td>${student.section}</td>
                    <td>${student.behavior}</td>
                    <td>${student.score}</td>
                    <td>${student.day}</td>
                    <td>${student.date}</td>
                    <td><input type="text" value="${student.notes || ''}" onchange="updateSavedStudentNotes(${index}, this.value)"></td>
                    <td><button class="delete-btn" onclick="deleteSavedStudent(${index})">حذف</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateSavedStudentNotes(index, notes) {
            savedStudents[index].notes = notes;
            saveSavedData();
            saveToHistory();
        }

        function deleteSavedStudent(index) {
            savedStudents.splice(index, 1);
            renderSavedTable();
            saveSavedData();
            saveToHistory();
        }

        function filterSavedTable() {
            const gradeFilter = document.getElementById('filterGrade').value;
            const filteredStudents = savedStudents.filter(student => !gradeFilter || student.grade === gradeFilter);
            const tableBody = document.getElementById('savedTableBody');
            tableBody.innerHTML = '';
            filteredStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.grade}</td>
                    <td>${student.section}</td>
                    <td>${student.behavior}</td>
                    <td>${student.score}</td>
                    <td>${student.day}</td>
                    <td>${student.date}</td>
                    <td><input type="text" value="${student.notes || ''}" onchange="updateSavedStudentNotes(${savedStudents.indexOf(student)}, this.value)"></td>
                    <td><button class="delete-btn" onclick="deleteSavedStudent(${savedStudents.indexOf(student)})">حذف</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function exportToExcel() {
            const table = document.getElementById('savedTable');
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'كشف المتابعة');
            XLSX.writeFile(wb, 'كشف_المتابعة.xlsx');
        }

        function exportParticipationToExcel() {
            const table = document.getElementById('participationTable');
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'المشاركة والواجبات');
            XLSX.writeFile(wb, 'المشاركة_والواجبات.xlsx');
        }

        function updateParticipationTable() {
            const gradeFilter = document.getElementById('filterParticipationGrade').value;
            const sectionFilter = document.getElementById('filterParticipationSection').value;
            const filteredStudents = students.filter(student => 
                (!gradeFilter || student.grade === gradeFilter) &&
                (!sectionFilter || student.section === sectionFilter)
            );
            const tableBody = document.getElementById('participationTableBody');
            tableBody.innerHTML = '';
            filteredStudents.forEach(student => {
                const studentKey = `${student.name}_${student.grade}_${student.section}`;
                if (!participationData[studentKey]) {
                    participationData[studentKey] = { participation: 0, homework: 0, participationScore: 10, homeworkScore: 10 };
                }
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>
                        <div class="checkbox-group">
                            ${Array(5).fill().map((_, i) => `
                                <label class="checkbox-label ${participationData[studentKey].participation > i ? 'checked' : ''}">
                                    <input type="checkbox" ${participationData[studentKey].participation > i ? 'checked' : ''} onchange="updateParticipation('${studentKey}', 'participation', ${i + 1}, this.checked)">
                                </label>
                            `).join('')}
                        </div>
                    </td>
                    <td><input type="number" value="${participationData[studentKey].participationScore}" min="0" max="10" onchange="updateParticipationScore('${studentKey}', 'participationScore', this.value)"></td>
                    <td>
                        <div class="checkbox-group">
                            ${Array(5).fill().map((_, i) => `
                                <label class="checkbox-label ${participationData[studentKey].homework > i ? 'checked' : ''}">
                                    <input type="checkbox" ${participationData[studentKey].homework > i ? 'checked' : ''} onchange="updateParticipation('${studentKey}', 'homework', ${i + 1}, this.checked)">
                                </label>
                            `).join('')}
                        </div>
                    </td>
                    <td><input type="number" value="${participationData[studentKey].homeworkScore}" min="0" max="10" onchange="updateParticipationScore('${studentKey}', 'homeworkScore', this.value)"></td>
                `;
                tableBody.appendChild(row);
            });
            saveParticipationData();
        }

        function updateParticipation(studentKey, field, value, checked) {
            const currentCount = participationData[studentKey][field];
            participationData[studentKey][field] = checked ? value : Math.max(0, value - 1);
            const scoreField = field === 'participation' ? 'participationScore' : 'homeworkScore';
            if (checked && participationData[studentKey][field] > currentCount) {
                participationData[studentKey][scoreField] = Math.max(0, participationData[studentKey][scoreField] - 1);
            } else if (!checked && participationData[studentKey][field] < currentCount) {
                participationData[studentKey][scoreField] = Math.min(10, participationData[studentKey][scoreField] + 1);
            }
            updateParticipationTable();
            saveParticipationData();
            saveToHistory();
        }

        function updateParticipationScore(studentKey, field, value) {
            participationData[studentKey][field] = parseInt(value) || 0;
            updateParticipationTable();
            saveParticipationData();
            saveToHistory();
        }

        function updateParticipationSections() {
            const gradeFilter = document.getElementById('filterParticipationGrade').value;
            const sections = [...new Set(students.filter(s => !gradeFilter || s.grade === gradeFilter).map(s => s.section).filter(s => s))];
            const sectionSelect = document.getElementById('filterParticipationSection');
            sectionSelect.innerHTML = '<option value="">جميع الفصول</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
            updateParticipationTable();
        }

        function updateStatsChart() {
            const grade = document.getElementById('statsGrade').value;
            const section = document.getElementById('statsSection').value;
            const filteredStudents = savedStudents.filter(student => 
                (!grade || student.grade === grade) &&
                (!section || student.section === section)
            );
            const behaviorCounts = { 'نسي الكتاب': 0, 'التحدث أثناء الدرس': 0, 'متأخر': 0, 'نائم': 0, 'رجوع': 0 };
            filteredStudents.forEach(student => {
                if (student.behavior && behaviorCounts.hasOwnProperty(student.behavior)) {
                    behaviorCounts[student.behavior]++;
                }
            });
            const ctx = document.getElementById('statsChart').getContext('2d');
            if (statsChart) statsChart.destroy();
            statsChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(behaviorCounts),
                    datasets: [{
                        label: 'عدد المخالفات',
                        data: Object.values(behaviorCounts),
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                        borderColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'إحصائيات السلوك'
                        }
                    }
                }
            });
        }

        function updateStatsSections() {
            const grade = document.getElementById('statsGrade').value;
            const sections = [...new Set(savedStudents.filter(s => !grade || s.grade === grade).map(s => s.section).filter(s => s))];
            const sectionSelect = document.getElementById('statsSection');
            sectionSelect.innerHTML = '<option value="">اختر الفصل</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
        }

        function updateSendSections() {
            const grade = document.getElementById('sendGrade').value;
            const sections = [...new Set(students.filter(s => !grade || s.grade === grade).map(s => s.section).filter(s => s))];
            const sectionSelect = document.getElementById('sendSection');
            sectionSelect.innerHTML = '<option value="">اختر الفصل</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
            updateFilteredStudentList();
        }

        function updateFilteredStudentList() {
            const grade = document.getElementById('sendGrade').value;
            const section = document.getElementById('sendSection').value;
            const filteredStudents = students.filter(student => 
                (!grade || student.grade === grade) &&
                (!section || student.section === section)
            );
            const studentSelect = document.getElementById('filteredStudents');
            studentSelect.innerHTML = '<option value="">اختر الطالب</option>';
            filteredStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.name;
                option.textContent = student.name;
                studentSelect.appendChild(option);
            });
        }

        function displayStudentDetails() {
            const studentName = document.getElementById('filteredStudents').value;
            if (!studentName) {
                document.getElementById('studentDetailsTable').style.display = 'none';
                document.getElementById('whatsappButton').style.display = 'none';
                return;
            }
            const studentRecords = savedStudents.filter(s => s.name === studentName);
            const tableBody = document.getElementById('studentDetailsBody');
            tableBody.innerHTML = '';
            studentRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.name}</td>
                    <td>${record.grade}</td>
                    <td>${record.section}</td>
                    <td>${record.behavior}</td>
                    <td>${record.score}</td>
                    <td>${record.notes}</td>
                `;
                tableBody.appendChild(row);
            });
            document.getElementById('studentDetailsTable').style.display = 'table';
            document.getElementById('whatsappButton').style.display = 'block';
        }

        function sendToWhatsApp() {
            const studentName = document.getElementById('filteredStudents').value;
            const studentRecords = savedStudents.filter(s => s.name === studentName);
            let message = `تقرير الطالب: ${studentName}\n\n`;
            studentRecords.forEach(record => {
                message += `التاريخ: ${record.date}\n`;
                message += `الصف: ${record.grade}\n`;
                message += `الفصل: ${record.section}\n`;
                message += `السلوك: ${record.behavior}\n`;
                message += `الدرجة: ${record.score}\n`;
                message += `ملاحظات: ${record.notes}\n\n`;
            });
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            const imageFiles = [];
            const videoFiles = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image')) {
                    imageFiles.push(file);
                } else if (file.type.startsWith('video')) {
                    videoFiles.push(file);
                }
            }

            if (imageFiles.length > 0) {
                const newImageGroup = [];
                for (const file of imageFiles) {
                    const mediaItem = {
                        blob: file,
                        type: 'image',
                        description: ''
                    };
                    newImageGroup.push(mediaItem);
                }
                mediaGroups.push(newImageGroup);
                await saveMediaData();
                renderMediaItems();
                saveToHistory();
            }

            if (videoFiles.length > 0) {
                for (const file of videoFiles) {
                    const videoItem = {
                        blob: file,
                        type: 'video',
                        description: ''
                    };
                    videoItems.push(videoItem);
                }
                await saveVideoData();
                renderVideoItems();
                saveToHistory();
            }

            document.getElementById('mediaUpload').value = '';
        }

        async function addMediaFromLink() {
            const link = document.getElementById('mediaLink').value.trim();
            if (!link) {
                alert('يرجى إدخال رابط الصورة أو الفيديو');
                return;
            }
            const mediaItem = {
                src: link,
                type: link.includes('youtube.com') || link.includes('youtu.be') ? 'youtube' : 'image',
                description: ''
            };

            if (mediaItem.type === 'image') {
                mediaGroups.push([mediaItem]);
                await saveMediaData();
                renderMediaItems();
            } else {
                videoItems.push(mediaItem);
                await saveVideoData();
                renderVideoItems();
            }

            document.getElementById('mediaLink').value = '';
            saveToHistory();
        }

        function renderMediaItems() {
            const container = document.getElementById('mediaContainer');
            container.innerHTML = '';

            mediaGroups.forEach((group, groupIndex) => {
                if (group.length === 0) return;

                const column = document.createElement('div');
                column.className = 'media-column';

                const slideContainer = document.createElement('div');
                slideContainer.className = 'media-slide-container';
                slideContainer.setAttribute('data-group-index', groupIndex);

                group.forEach((item, index) => {
                    const slide = document.createElement('div');
                    slide.className = `media-slide ${index === 0 ? 'active' : ''}`;
                    let imgSrc = '';
                    if (item.blob) {
                        imgSrc = URL.createObjectURL(item.blob);
                    } else if (item.src) {
                        imgSrc = item.src;
                    }
                    slide.innerHTML = `
                        <img src="${imgSrc}" onclick="openFullscreen(${groupIndex}, ${index})">
                        <textarea placeholder="أدخل وصفًا للصورة" onchange="updateMediaDescription(${groupIndex}, ${index}, this.value)">${item.description}</textarea>
                    `;
                    slideContainer.appendChild(slide);
                });

                if (group.length > 1) {
                    const controls = document.createElement('div');
                    controls.className = 'media-slide-controls';
                    controls.innerHTML = `
                        <button class="nav-btn" onclick="changeSlide(${groupIndex}, -1)">❮</button>
                        <button class="delete-btn" onclick="deleteMediaItem(${groupIndex}, 0)">حذف</button>
                        <button class="nav-btn" onclick="changeSlide(${groupIndex}, 1)">❯</button>
                    `;
                    slideContainer.appendChild(controls);
                } else {
                    const controls = document.createElement('div');
                    controls.className = 'media-slide-controls';
                    controls.innerHTML = `
                        <button class="delete-btn" onclick="deleteMediaItem(${groupIndex}, 0)">حذف</button>
                    `;
                    slideContainer.appendChild(controls);
                }

                column.appendChild(slideContainer);
                container.appendChild(column);
            });
        }

        function renderVideoItems() {
            const container = document.getElementById('videoContainer');
            container.innerHTML = '';

            videoItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'media-item video-item';
                let mediaElement = '';
                if (item.type === 'video') {
                    const videoSrc = URL.createObjectURL(item.blob);
                    mediaElement = `<video src="${videoSrc}" controls></video>`;
                } else if (item.type === 'youtube') {
                    const videoId = item.src.includes('youtu.be') ? item.src.split('/').pop() : new URLSearchParams(new URL(item.src).search).get('v');
                    mediaElement = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                }
                div.innerHTML = `
                    ${mediaElement}
                    <textarea placeholder="أدخل وصفًا للفيديو" onchange="updateVideoDescription(${index}, this.value)">${item.description}</textarea>
                    <button class="delete-btn" onclick="deleteVideoItem(${index})">حذف</button>
                `;
                container.appendChild(div);
            });
        }

        function changeSlide(groupIndex, direction) {
            const slideContainer = document.querySelector(`.media-slide-container[data-group-index="${groupIndex}"]`);
            const slides = slideContainer.querySelectorAll('.media-slide');
            let currentIndex = Array.from(slides).findIndex(slide => slide.classList.contains('active'));
            slides[currentIndex].classList.remove('active');
            currentIndex = (currentIndex + direction + slides.length) % slides.length;
            slides[currentIndex].classList.add('active');

            const deleteBtn = slideContainer.querySelector('.media-slide-controls .delete-btn');
            deleteBtn.setAttribute('onclick', `deleteMediaItem(${groupIndex}, ${currentIndex})`);
        }

        async function updateMediaDescription(groupIndex, index, description) {
            mediaGroups[groupIndex][index].description = description;
            await saveMediaData();
            saveToHistory();
        }

        async function updateVideoDescription(index, description) {
            videoItems[index].description = description;
            await saveVideoData();
            saveToHistory();
        }

        async function deleteMediaItem(groupIndex, index) {
            if (confirm('هل أنت متأكد من حذف هذه الصورة؟')) {
                mediaGroups[groupIndex].splice(index, 1);
                if (mediaGroups[groupIndex].length === 0) {
                    mediaGroups.splice(groupIndex, 1);
                }
                await saveMediaData();
                renderMediaItems();
                saveToHistory();
            }
        }

        async function deleteVideoItem(index) {
            if (confirm('هل أنت متأكد من حذف هذا الفيديو؟')) {
                videoItems.splice(index, 1);
                await saveVideoData();
                renderVideoItems();
                saveToHistory();
            }
        }

        function openFullscreen(groupIndex, index) {
            currentGroupIndex = groupIndex;
            currentImageIndex = index;
            imageSources = mediaGroups[groupIndex].map(item => item.blob ? URL.createObjectURL(item.blob) : item.src);
            const overlay = document.getElementById('fullscreenOverlay');
            const img = document.getElementById('fullscreenImage');
            img.src = imageSources[currentImageIndex];
            overlay.style.display = 'flex';
            updateNavigationButtons();
        }

        function closeFullscreen() {
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.style.display = 'none';
            currentImageIndex = -1;
            currentGroupIndex = -1;
            imageSources = [];
        }

        function navigateImages(direction) {
            currentImageIndex = (currentImageIndex + direction + imageSources.length) % imageSources.length;
            const img = document.getElementById('fullscreenImage');
            img.src = imageSources[currentImageIndex];
            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            const prevBtn = document.querySelector('.prev-btn');
            const nextBtn = document.querySelector('.next-btn');
            if (imageSources.length <= 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'block';
                nextBtn.style.display = 'block';
            }
        }

        async function handlePDFUpload(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const pdfItem = {
                    blob: file,
                    description: ''
                };
                pdfItems.push(pdfItem);
            }
            await savePDFData();
            renderPDFItems();
            saveToHistory();
            document.getElementById('pdfUpload').value = '';
        }

        async function addPDFFromLink() {
            const link = document.getElementById('pdfLink').value.trim();
            if (!link) {
                alert('يرجى إدخال رابط ملف PDF');
                return;
            }
            const pdfItem = {
                src: link,
                description: ''
            };
            pdfItems.push(pdfItem);
            await savePDFData();
            renderPDFItems();
            document.getElementById('pdfLink').value = '';
            saveToHistory();
        }

        function renderPDFItems() {
            const container = document.getElementById('pdfContainer');
            container.innerHTML = '';
            pdfItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'pdf-item';
                div.setAttribute('draggable', 'true');
                let src = item.blob ? URL.createObjectURL(item.blob) : item.src;
                div.innerHTML = `
                    <embed src="${src}" type="application/pdf">
                    <button class="open-btn" onclick="openPDFInNewTab('${src}')">فتح في صفحة جديدة</button>
                    <textarea placeholder="أدخل وصفًا للملف" onchange="updatePDFDescription(${index}, this.value)">${item.description}</textarea>
                    <button class="delete-btn" onclick="deletePDFItem(${index})">حذف</button>
                `;
                container.appendChild(div);
            });
            setupPDFDragAndDrop();
        }

        function openPDFInNewTab(src) {
            try {
                window.open(src, '_blank');
            } catch (error) {
                console.error('خطأ في فتح ملف PDF:', error);
                alert('حدث خطأ أثناء فتح ملف PDF. يرجى التأكد من أن الرابط صحيح أو أن الملف متاح.');
            }
        }

        async function updatePDFDescription(index, description) {
            pdfItems[index].description = description;
            await savePDFData();
            saveToHistory();
        }

        async function deletePDFItem(index) {
            if (confirm('هل أنت متأكد من حذف هذا الملف؟')) {
                pdfItems.splice(index, 1);
                await savePDFData();
                renderPDFItems();
                saveToHistory();
            }
        }

        function saveKashfData() {
            localStorage.setItem('students', JSON.stringify(students));
        }

        function loadKashfData() {
            const data = localStorage.getItem('students');
            if (data) {
                students = JSON.parse(data);
                students.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            }
        }

        function saveSavedData() {
            localStorage.setItem('savedStudents', JSON.stringify(savedStudents));
        }

        function loadSavedData() {
            const data = localStorage.getItem('savedStudents');
            if (data) {
                savedStudents = JSON.parse(data);
            }
        }

        function saveParticipationData() {
            localStorage.setItem('participationData', JSON.stringify(participationData));
        }

        function loadParticipationData() {
            const data = localStorage.getItem('participationData');
            if (data) {
                participationData = JSON.parse(data);
            }
        }

        async function saveMediaData() {
            const transaction = db.transaction(['mediaGroups'], 'readwrite');
            const store = transaction.objectStore('mediaGroups');
            await store.clear();
            mediaGroups.forEach((group, index) => {
                store.add({ id: index + 1, data: group });
            });
        }

        async function loadMediaData() {
            const transaction = db.transaction(['mediaGroups'], 'readonly');
            const store = transaction.objectStore('mediaGroups');
            const request = store.getAll();
            return new Promise((resolve) => {
                request.onsuccess = function() {
                    mediaGroups = request.result.map(item => item.data);
                    resolve();
                };
            });
        }

        async function saveVideoData() {
            const transaction = db.transaction(['videoItems'], 'readwrite');
            const store = transaction.objectStore('videoItems');
            await store.clear();
            videoItems.forEach((item, index) => {
                store.add({ id: index + 1, data: item });
            });
        }

        async function loadVideoData() {
            const transaction = db.transaction(['videoItems'], 'readonly');
            const store = transaction.objectStore('videoItems');
            const request = store.getAll();
            return new Promise((resolve) => {
                request.onsuccess = function() {
                    videoItems = request.result.map(item => item.data);
                    resolve();
                };
            });
        }

        async function savePDFData() {
            localStorage.setItem('pdfItems', JSON.stringify(pdfItems));
        }

        async function loadPDFData() {
            const data = localStorage.getItem('pdfItems');
            if (data) {
                pdfItems = JSON.parse(data);
            }
        }

        function saveToHistory() {
            historyStack.push({
                students: JSON.parse(JSON.stringify(students)),
                savedStudents: JSON.parse(JSON.stringify(savedStudents)),
                participationData: JSON.parse(JSON.stringify(participationData)),
                mediaGroups: JSON.parse(JSON.stringify(mediaGroups)),
                videoItems: JSON.parse(JSON.stringify(videoItems)),
                pdfItems: JSON.parse(JSON.stringify(pdfItems))
            });
            if (historyStack.length > 50) {
                historyStack.shift();
            }
        }

        function setupPDFDragAndDrop() {
            const container = document.getElementById('pdfContainer');
            const items = container.querySelectorAll('.pdf-item');

            items.forEach(item => {
                item.addEventListener('dragstart', () => {
                    item.classList.add('dragging');
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    const newOrder = Array.from(container.querySelectorAll('.pdf-item')).map((el, index) => {
                        return pdfItems[parseInt(el.querySelector('textarea').getAttribute('onchange').match(/\d+/)[0])];
                    });
                    pdfItems = newOrder;
                    savePDFData();
                    saveToHistory();
                });
            });

            container.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (afterElement == null) {
                    container.appendChild(dragging);
                } else {
                    container.insertBefore(dragging, afterElement);
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.pdf-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
    </script>
</body>
</html>
