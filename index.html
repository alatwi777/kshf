<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>كشف المتابعة اليومي</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .tab {
            overflow: hidden;
            background-color: #f1f1f1;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 5px;
            border-radius: 8px;
        }
        .tab button {
            flex: 0 0 auto;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 12px 20px;
            font-size: 16px;
            transition: 0.3s;
            border-radius: 5px;
            color: white;
            min-width: 120px;
            text-align: center;
        }
        .tab button:hover {
            opacity: 0.9;
        }
        .tab button.active {
            opacity: 0.7;
        }
        .tablinks.kashf-tab { background-color: #42A5F5; }
        .tablinks.input-table-tab { background-color: #4DD0E1; }
        .tablinks.stats-tab { background-color: #FFCA28; }
        .tablinks.books-tab { background-color: #66BB6A; }
        .tablinks.send-tab { background-color: #26A69A; }
        .tablinks.media-tab { background-color: #EF5350; }
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        th {
            background-color: #f2f2f2;
        }
        .student-name {
            font-weight: bold;
        }
        select, input, textarea {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .control-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .control-section input[type="text"], .control-section textarea {
            flex: 1;
            min-width: 200px;
        }
        .control-section textarea {
            height: 100px;
            resize: vertical;
        }
        .control-section select {
            width: 150px;
        }
        button {
            padding: 6px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .delete-btn { background-color: #f44336; }
        .delete-btn:hover { background-color: #da190b; }
        .delete-all-btn { background-color: #d32f2f; }
        .delete-all-btn:hover { background-color: #b71c1c; }
        .filter-btn { background-color: #2196F3; }
        .filter-btn:hover { background-color: #0b7dda; }
        .toggle-btn { background-color: #FF9800; }
        .toggle-btn:hover { background-color: #F57C00; }
        .save-btn { background-color: #673AB7; }
        .save-btn:hover { background-color: #5E35B1; }
        .save-all-btn { background-color: #3F51B5; }
        .save-all-btn:hover { background-color: #303F9F; }
        .export-btn { background-color: #28a745; }
        .export-btn:hover { background-color: #218838; }
        .whatsapp-btn { background-color: #25D366; }
        .whatsapp-btn:hover { background-color: #20BD57; }
        .upload-btn { background-color: #FF5722; }
        .upload-btn:hover { background-color: #E64A19; }
        .add-link-btn { background-color: #9C27B0; }
        .add-link-btn:hover { background-color: #7B1FA2; }
        .open-btn { background-color: #0288D1; }
        .open-btn:hover { background-color: #0277BD; }
        .checkbox-group {
            display: flex;
            flex-direction: row;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }
        .filter-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .move-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        .move-btn {
            background-color: #2196F3;
            padding: 4px 8px;
            margin: 2px 0;
            width: 24px;
            height: 24px;
            line-height: 20px;
            font-size: 12px;
        }
        .move-btn:hover {
            background-color: #0b7dda;
        }
        .increment-btn, .decrement-btn {
            background-color: #4CAF50;
            padding: 2px 6px;
            margin: 2px 0;
            width: 24px;
            height: 24px;
            line-height: 20px;
            font-size: 12px;
        }
        .increment-btn:hover, .decrement-btn:hover {
            background-color: #45a049;
        }
        .score-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            justify-content: center;
            width: 30px;
            margin: 0 auto;
        }
        .score-control span {
            font-size: 14px;
            font-weight: bold;
        }
        tr.dragging, .media-item.dragging, .pdf-item.dragging {
            opacity: 0.5;
            background-color: #f0f0f0;
        }
        #booksIframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        .checkbox-container {
            display: flex;
            flex-direction: row;
            gap: 5px;
            align-items: center;
        }
        .media-item, .pdf-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .media-item img, .media-item video, .media-item iframe, .media-item audio {
            max-width: 200px;
            max-height: 200px;
            border-radius: 4px;
            cursor: pointer;
        }
        .media-item textarea, .pdf-item textarea {
            flex: 1;
            height: 60px;
            resize: vertical;
        }
        .pdf-item a, .media-item a {
            color: #2196F3;
            text-decoration: none;
            font-weight: bold;
        }
        .pdf-item a:hover, .media-item a:hover {
            text-decoration: underline;
        }
        .pdf-item embed {
            width: 200px;
            height: 200px;
            border-radius: 4px;
        }
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .fullscreen-overlay img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        .fullscreen-overlay .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .fullscreen-overlay .close-btn:hover {
            background: #da190b;
        }
        .fullscreen-overlay .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
        }
        .fullscreen-overlay .nav-btn:hover {
            background: #0b7dda;
        }
        .fullscreen-overlay .prev-btn {
            left: 20px;
        }
        .fullscreen-overlay .next-btn {
            right: 20px;
        }
        #statsChart {
            max-width: 600px;
            margin: 20px auto;
        }
        .no-students-message {
            color: #f44336;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
        }
        .media-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .media-column {
            flex: 1;
            min-width: 300px;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .media-slide-container {
            position: relative;
            width: 100%;
            text-align: center;
        }
        .media-slide {
            display: none;
            width: 100%;
        }
        .media-slide.active {
            display: block;
        }
        .media-slide img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            cursor: pointer;
        }
        .media-slide video, .media-slide iframe, .media-slide audio {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
        }
        .media-slide textarea {
            width: 100%;
            margin-top: 10px;
        }
        .media-slide-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .media-slide-controls .delete-btn {
            background-color: #f44336;
        }
        .media-slide-controls .delete-btn:hover {
            background-color: #da190b;
        }
        .media-slide-controls .nav-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .media-slide-controls .nav-btn:hover {
            background: #0b7dda;
        }
        .batch-checkbox-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 10px 0;
        }
        .batch-checkbox-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .batch-checkbox-group label {
            font-size: 14px;
        }
        .grade-upload-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .grade-upload-section button {
            background-color: #FF9800;
        }
        .grade-upload-section button:hover {
            background-color: #F57C00;
        }
        .media-group {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .media-group-header {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .behavior-entry {
            margin-bottom: 5px;
        }
        col.move { width: 5%; }
        col.student-name { width: 20%; }
        col.grade { width: 20%; }
        col.section { width: 15%; }
        col.behavior { width: 15%; }
        col.score { width: 5%; }
        col.save { width: 5%; }
        col.delete { width: 5%; }
        col.participation-score { width: 5%; }
        col.homework-score { width: 5%; }
        col.saved-student-name { width: 20%; }
        col.saved-grade { width: 15%; }
        col.saved-section { width: 8%; }
        col.saved-behavior { width: 20%; }
        col.saved-score { width: 8%; }
        col.saved-notes { width: 19%; }
        col.saved-delete { width: 5%; }
    </style>
</head>
<body>
    <div class="container">
        <h2>كشف المتابعة اليومي</h2>
        <div class="tab">
            <button class="tablinks kashf-tab active" onclick="openTab(event, 'kashf')">الكشف</button>
            <button class="tablinks input-table-tab" onclick="openTab(event, 'inputTable')">جدول الإدخال</button>
            <button class="tablinks stats-tab" onclick="openTab(event, 'stats')">إحصائيات</button>
            <button class="tablinks books-tab" onclick="openTab(event, 'books')">الكتب الدراسية</button>
            <button class="tablinks send-tab" onclick="openTab(event, 'send')">إرسال</button>
            <button class="tablinks media-tab" onclick="openTab(event, 'media')">الوسائط</button>
        </div>
        <div id="kashf" class="tabcontent" style="display: block;">
            <div class="control-section">
                <input type="text" id="studentName" placeholder="اسم الطالب" onkeypress="if(event.key === 'Enter') addStudent()">
                <button onclick="addStudent()">إضافة طالب</button>
                <button class="delete-all-btn" onclick="deleteAllKashfRows()">حذف الكل</button>
                <button class="save-all-btn" onclick="saveAllStudents()">حفظ الكل</button>
                <button class="export-btn" onclick="exportKashfToExcel()">تصدير إلى Excel</button>
            </div>
            <div class="control-section">
                <div id="multipleStudentsContainer" style="display: block;">
                    <textarea id="multipleStudents" placeholder="أدخل أسماء الطلاب (كل اسم في سطر)" onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); addMultipleStudents(); }"></textarea>
                    <button onclick="addMultipleStudents()">إضافة الطلاب دفعة واحدة</button>
                </div>
                <button class="toggle-btn" onclick="toggleMultipleStudentsInput()">إخفاء الحقل</button>
            </div>
            <div class="batch-checkbox-section">
                <div class="batch-checkbox-group">
                    <label><input type="checkbox" id="batchGrade1" onchange="updateBatchGrade(this, 'الأول متوسط')"> الأول متوسط</label>
                    <label><input type="checkbox" id="batchGrade2" onchange="updateBatchGrade(this, 'الثاني متوسط')"> الثاني متوسط</label>
                    <label><input type="checkbox" id="batchGrade3" onchange="updateBatchGrade(this, 'الثالث متوسط')"> الثالث متوسط</label>
                </div>
                <div class="batch-checkbox-group">
                    <label><input type="checkbox" id="batchSection1" onchange="updateBatchSection(this, '1')"> 1</label>
                    <label><input type="checkbox" id="batchSection2" onchange="updateBatchSection(this, '2')"> 2</label>
                    <label><input type="checkbox" id="batchSection3" onchange="updateBatchSection(this, '3')"> 3</label>
                </div>
            </div>
            <div class="filter-section">
                <button class="filter-btn" onclick="filterKashfTable()">تصفية</button>
                <select id="filterKashfGrade" onchange="updateKashfSections()">
                    <option value="">جميع الصفوف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <select id="filterKashfSection" onchange="filterKashfTable()">
                    <option value="">جميع الفصول</option>
                </select>
            </div>
            <table id="dailyTable">
                <colgroup>
                    <col class="move">
                    <col class="student-name">
                    <col class="grade">
                    <col class="section">
                    <col class="behavior">
                    <col class="score">
                    <col class="save">
                    <col class="delete">
                    <col class="participation-score">
                    <col class="homework-score">
                </colgroup>
                <thead>
                    <tr>
                        <th>تحريك</th>
                        <th>الاسم</th>
                        <th>الصف</th>
                        <th>الفصل</th>
                        <th>السلوك</th>
                        <th>الدرجة</th>
                        <th>حفظ</th>
                        <th>حذف</th>
                        <th>م</th>
                        <th>و</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div id="noStudentsMessage" class="no-students-message" style="display: none;">
                لا توجد أسماء تتطابق مع التصفية. حاول تغيير الصف أو الفصل.
            </div>
        </div>
        <div id="inputTable" class="tabcontent">
            <div class="filter-section">
                <button class="filter-btn" onclick="filterSavedTable()">تصفية حسب الصف</button>
                <select id="filterGrade" onchange="filterSavedTable()">
                    <option value="">جميع الصفوف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <button class="export-btn" onclick="exportToExcel()">تصدير إلى Excel</button>
            </div>
            <table id="savedTable">
                <colgroup>
                    <col class="saved-student-name">
                    <col class="saved-grade">
                    <col class="saved-section">
                    <col class="saved-behavior">
                    <col class="saved-score">
                    <col class="saved-notes">
                    <col class="saved-delete">
                </colgroup>
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>الصف</th>
                        <th>الفصل</th>
                        <th>السلوكيات</th>
                        <th>الدرجة</th>
                        <th>ملاحظات على الطالب</th>
                        <th>حذف</th>
                    </tr>
                </thead>
                <tbody id="savedTableBody"></tbody>
            </table>
        </div>
        <div id="stats" class="tabcontent">
            <div class="control-section">
                <select id="statsGrade" onchange="updateStatsSections(); updateStatsChart()">
                    <option value="">اختر الصف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <select id="statsSection" onchange="updateStatsChart()">
                    <option value="">اختر الفصل</option>
                </select>
            </div>
            <canvas id="statsChart"></canvas>
        </div>
        <div id="books" class="tabcontent">
            <iframe id="booksIframe" src="https://ktby.net" title="الكتب الدراسية"></iframe>
        </div>
        <div id="send" class="tabcontent">
            <div class="control-section">
                <select id="sendGrade" onchange="updateSendSections()">
                    <option value="">اختر الصف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <select id="sendSection" onchange="updateFilteredStudentList()">
                    <option value="">اختر الفصل</option>
                </select>
                <select id="filteredStudents" onchange="displayStudentDetails()">
                    <option value="">اختر الطالب</option>
                </select>
            </div>
            <table id="studentDetailsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>الصف</th>
                        <th>الفصل</th>
                        <th>جميع السلوكيات</th>
                        <th>الدرجة</th>
                        <th>ملاحظات على الطالب</th>
                    </tr>
                </thead>
                <tbody id="studentDetailsBody"></tbody>
            </table>
            <div id="whatsappButton" style="display: none; margin-top: 10px;">
                <button class="whatsapp-btn" onclick="sendToWhatsApp()">إرسال عبر واتساب</button>
            </div>
        </div>
        <div id="media" class="tabcontent">
            <div class="grade-upload-section">
                <button class="upload-btn" onclick="document.getElementById('mediaUploadGrade1').click()">رفع للصف الأول متوسط</button>
                <input type="file" id="mediaUploadGrade1" accept="image/*,video/*,audio/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,application/zip" multiple style="display: none;" onchange="handleMediaUpload(event, 'الأول متوسط')">
                <button class="upload-btn" onclick="document.getElementById('mediaUploadGrade2').click()">رفع للصف الثاني متوسط</button>
                <input type="file" id="mediaUploadGrade2" accept="image/*,video/*,audio/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,application/zip" multiple style="display: none;" onchange="handleMediaUpload(event, 'الثاني متوسط')">
                <button class="upload-btn" onclick="document.getElementById('mediaUploadGrade3').click()">رفع للصف الثالث متوسط</button>
                <input type="file" id="mediaUploadGrade3" accept="image/*,video/*,audio/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,application/zip" multiple style="display: none;" onchange="handleMediaUpload(event, 'الثالث متوسط')">
            </div>
            <div class="control-section">
                <input type="text" id="mediaLink" placeholder="أدخل رابط الصورة، الفيديو، أو ملف PDF">
                <select id="mediaGradeSelect">
                    <option value="">اختر الصف</option>
                    <option value="الأول متوسط">الأول متوسط</option>
                    <option value="الثاني متوسط">الثاني متوسط</option>
                    <option value="الثالث متوسط">الثالث متوسط</option>
                </select>
                <button class="add-link-btn" onclick="addMediaFromLink()">إضافة من رابط</button>
            </div>
            <div id="mediaContainer"></div>
        </div>
        <div id="fullscreenOverlay" class="fullscreen-overlay">
            <img id="fullscreenImage" src="" alt="صورة مكبرة">
            <button class="close-btn" onclick="closeFullscreen()">إغلاق</button>
            <button class="nav-btn prev-btn" onclick="navigateImages(-1)">❮</button>
            <button class="nav-btn next-btn" onclick="navigateImages(1)">❯</button>
        </div>
    </div>
    <script>
        let students = [];
        let savedStudents = [];
        let mediaGroups = { 'الأول متوسط': [], 'الثاني متوسط': [], 'الثالث متوسط': [] };
        let statsChart = null;
        let currentTab = 'kashf';
        let historyStack = [];
        let currentImageIndex = -1;
        let imageSources = [];
        let currentGroupIndex = -1;
        let currentGrade = '';
        let batchGrade = '';
        let batchSection = '';
        let db;
        const dbName = "KashfDB";
        const dbVersion = 1;
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        async function autoSave() {
            try {
                saveKashfData();
                saveSavedData();
                await saveMediaData();
                console.log('تم الحفظ التلقائي بنجاح');
            } catch (error) {
                console.error('خطأ في الحفظ التلقائي:', error);
            }
        }
        const debouncedAutoSave = debounce(autoSave, 1000);
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);
                request.onupgradeneeded = function(event) {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('mediaGroups')) {
                        db.createObjectStore('mediaGroups', { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = function(event) {
                    db = event.target.result;
                    resolve();
                };
                request.onerror = function(event) {
                    console.error("Error opening IndexedDB:", event.target.error);
                    reject(event.target.error);
                };
            });
        }
        window.onload = async function() {
            try {
                await initDB();
                await loadAllData();
                renderKashfTable();
                openTab({ currentTarget: document.querySelector('.tablinks.kashf-tab') }, 'kashf');
            } catch (error) {
                console.error("Error during initialization:", error);
                alert("حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.");
            }
        };
        async function loadAllData() {
            await loadKashfData();
            await loadSavedData();
            await loadMediaData();
        }
        function saveKashfData() {
            localStorage.setItem('students', JSON.stringify(students));
        }
        function loadKashfData() {
            const data = localStorage.getItem('students');
            if (data) {
                students = JSON.parse(data);
                students.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            }
        }
        function saveSavedData() {
            localStorage.setItem('savedStudents', JSON.stringify(savedStudents));
        }
        function loadSavedData() {
            const data = localStorage.getItem('savedStudents');
            if (data) {
                savedStudents = JSON.parse(data);
                savedStudents.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            }
        }
        async function saveMediaData() {
            const transaction = db.transaction(['mediaGroups'], 'readwrite');
            const store = transaction.objectStore('mediaGroups');
            await store.clear();
            let id = 1;
            const chunkSize = 5 * 1024 * 1024;
            for (const grade in mediaGroups) {
                for (const group of mediaGroups[grade]) {
                    const chunkedGroup = [];
                    for (const item of group) {
                        if (item.blob && item.blob.size > chunkSize) {
                            const chunks = [];
                            for (let start = 0; start < item.blob.size; start += chunkSize) {
                                const chunk = item.blob.slice(start, start + chunkSize);
                                chunks.push(chunk);
                            }
                            chunkedGroup.push({ ...item, chunks, blob: null });
                        } else {
                            chunkedGroup.push(item);
                        }
                    }
                    store.add({ id: id++, grade: grade, data: chunkedGroup });
                }
            }
        }
        async function loadMediaData() {
            const transaction = db.transaction(['mediaGroups'], 'readonly');
            const store = transaction.objectStore('mediaGroups');
            const request = store.getAll();
            return new Promise((resolve) => {
                request.onsuccess = function() {
                    mediaGroups = { 'الأول متوسط': [], 'الثاني متوسط': [], 'الثالث متوسط': [] };
                    request.result.forEach(item => {
                        if (mediaGroups[item.grade]) {
                            const group = item.data.map(groupItem => {
                                if (groupItem.chunks) {
                                    const blob = new Blob(groupItem.chunks);
                                    return { ...groupItem, blob, chunks: null };
                                }
                                return groupItem;
                            });
                            mediaGroups[item.grade].push(group);
                        }
                    });
                    resolve();
                };
            });
        }
        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
            currentTab = tabName;
            try {
                if (tabName === 'stats') {
                    updateStatsChart();
                } else if (tabName === 'send') {
                    updateSendSections();
                    updateFilteredStudentList();
                } else if (tabName === 'media') {
                    renderMediaItems();
                } else if (tabName === 'kashf') {
                    renderKashfTable();
                } else if (tabName === 'inputTable') {
                    renderSavedTable();
                }
            } catch (error) {
                console.error(`Error in tab "${tabName}":`, error);
            }
        }
        function updateBatchGrade(checkbox, grade) {
            const grades = ['الأول متوسط', 'الثاني متوسط', 'الثالث متوسط'];
            const gradeCheckboxes = ['batchGrade1', 'batchGrade2', 'batchGrade3'];
            if (checkbox.checked) {
                batchGrade = grade;
                gradeCheckboxes.forEach((id, index) => {
                    if (grades[index] !== grade) {
                        document.getElementById(id).checked = false;
                    }
                });
            } else {
                batchGrade = '';
            }
        }
        function updateBatchSection(checkbox, section) {
            const sections = ['1', '2', '3'];
            const sectionCheckboxes = ['batchSection1', 'batchSection2', 'batchSection3'];
            if (checkbox.checked) {
                batchSection = section;
                sectionCheckboxes.forEach((id, index) => {
                    if (sections[index] !== section) {
                        document.getElementById(id).checked = false;
                    }
                });
            } else {
                batchSection = '';
            }
        }
        function addStudent() {
            const studentName = document.getElementById('studentName').value.trim();
            if (!studentName) {
                alert('يرجى إدخال اسم الطالب');
                return;
            }
            const student = {
                name: studentName,
                grade: batchGrade,
                section: batchSection,
                behavior: '',
                score: 20,
                participationScore: 10,
                homeworkScore: 10
            };
            students.push(student);
            students.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            renderKashfTable();
            document.getElementById('studentName').value = '';
            debouncedAutoSave();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
        }
        function addMultipleStudents() {
            const multipleStudentsInput = document.getElementById('multipleStudents').value.trim();
            if (!multipleStudentsInput) {
                alert('يرجى إدخال أسماء الطلاب');
                return;
            }
            const studentNames = multipleStudentsInput.split('\n').map(name => name.trim()).filter(name => name);
            studentNames.forEach(name => {
                const student = {
                    name: name,
                    grade: batchGrade,
                    section: batchSection,
                    behavior: '',
                    score: 20,
                    participationScore: 10,
                    homeworkScore: 10
                };
                students.push(student);
            });
            students.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            renderKashfTable();
            document.getElementById('multipleStudents').value = '';
            debouncedAutoSave();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
        }
        function toggleMultipleStudentsInput() {
            const container = document.getElementById('multipleStudentsContainer');
            const toggleButton = document.querySelector('.toggle-btn');
            container.style.display = container.style.display === 'block' ? 'none' : 'block';
            toggleButton.textContent = container.style.display === 'block' ? 'إخفاء الحقل' : 'إظهار الحقل';
        }
        function renderKashfTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            const noStudentsMessage = document.getElementById('noStudentsMessage');
            noStudentsMessage.style.display = 'none';
            students.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="move-control">
                            <button class="move-btn" onclick="moveRowUp(${index})" ${index === 0 ? 'disabled' : ''}>↑</button>
                            <button class="move-btn" onclick="moveRowDown(${index})" ${index === students.length - 1 ? 'disabled' : ''}>↓</button>
                        </div>
                    </td>
                    <td class="student-name"><input type="text" value="${student.name}" onchange="updateStudent(${index}, 'name', this.value)"></td>
                    <td>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="grade_${index}" value="الأول متوسط" ${student.grade === 'الأول متوسط' ? 'checked' : ''} onchange="updateStudent(${index}, 'grade', this)"> الأول متوسط</label>
                            <label><input type="checkbox" name="grade_${index}" value="الثاني متوسط" ${student.grade === 'الثاني متوسط' ? 'checked' : ''} onchange="updateStudent(${index}, 'grade', this)"> الثاني متوسط</label>
                            <label><input type="checkbox" name="grade_${index}" value="الثالث متوسط" ${student.grade === 'الثالث متوسط' ? 'checked' : ''} onchange="updateStudent(${index}, 'grade', this)"> الثالث متوسط</label>
                        </div>
                    </td>
                    <td>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="section_${index}" value="1" ${student.section === '1' ? 'checked' : ''} onchange="updateStudent(${index}, 'section', this)"> 1</label>
                            <label><input type="checkbox" name="section_${index}" value="2" ${student.section === '2' ? 'checked' : ''} onchange="updateStudent(${index}, 'section', this)"> 2</label>
                            <label><input type="checkbox" name="section_${index}" value="3" ${student.section === '3' ? 'checked' : ''} onchange="updateStudent(${index}, 'section', this)"> 3</label>
                        </div>
                    </td>
                    <td>
                        <select onchange="updateBehavior(${index}, this.value)">
                            <option value="">اختر السلوك</option>
                            <option value="نسي الكتاب" ${student.behavior === 'نسي الكتاب' ? 'selected' : ''}>نسي الكتاب</option>
                            <option value="التحدث أثناء الدرس" ${student.behavior === 'التحدث أثناء الدرس' ? 'selected' : ''}>التحدث أثناء الدرس</option>
                            <option value="متأخر" ${student.behavior === 'متأخر' ? 'selected' : ''}>متأخر</option>
                            <option value="نائم" ${student.behavior === 'نائم' ? 'selected' : ''}>نائم</option>
                            <option value="رجوع" ${student.behavior === 'رجوع' ? 'selected' : ''}>رجوع</option>
                        </select>
                    </td>
                    <td><input type="number" value="${student.score}" min="0" max="20" onchange="updateStudent(${index}, 'score', this.value)"></td>
                    <td><button class="save-btn" onclick="saveStudent(${index})">حفظ</button></td>
                    <td><button class="delete-btn" onclick="deleteStudent(${index})">حذف</button></td>
                    <td>
                        <div class="score-control">
                            <button class="increment-btn" onclick="incrementScore(${index}, 'participationScore')">+</button>
                            <span>${student.participationScore}</span>
                            <button class="decrement-btn" onclick="decrementScore(${index}, 'participationScore')">-</button>
                        </div>
                    </td>
                    <td>
                        <div class="score-control">
                            <button class="increment-btn" onclick="incrementScore(${index}, 'homeworkScore')">+</button>
                            <span>${student.homeworkScore}</span>
                            <button class="decrement-btn" onclick="decrementScore(${index}, 'homeworkScore')">-</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            if (students.length === 0) {
                noStudentsMessage.style.display = 'block';
                noStudentsMessage.textContent = 'لا توجد أسماء لعرضها. أضف طلابًا جدد.';
            }
            updateKashfSections();
        }
        function moveRowUp(index) {
            if (index > 0) {
                [students[index], students[index - 1]] = [students[index - 1], students[index]];
                renderKashfTable();
                debouncedAutoSave();
                saveToHistory();
            }
        }
        function moveRowDown(index) {
            if (index < students.length - 1) {
                [students[index], students[index + 1]] = [students[index + 1], students[index]];
                renderKashfTable();
                debouncedAutoSave();
                saveToHistory();
            }
        }
        function updateStudent(index, field, value) {
            if (field === 'grade' || field === 'section') {
                const checkboxes = document.getElementsByName(`${field}_${index}`);
                checkboxes.forEach(checkbox => {
                    if (checkbox !== value) checkbox.checked = false;
                });
                students[index][field] = value.checked ? value.value : '';
            } else {
                students[index][field] = value;
            }
            students.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            renderKashfTable();
            debouncedAutoSave();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
        }
        function updateBehavior(index, behavior) {
            students[index].behavior = behavior;
            if (behavior === 'رجوع') {
                students[index].score = 20;
            } else if (behavior && behavior !== '') {
                students[index].score = Math.max(0, students[index].score - 2);
            }
            renderKashfTable();
            debouncedAutoSave();
            saveToHistory();
        }
        function incrementScore(index, field) {
            const currentScore = students[index][field];
            if (currentScore < 10) {
                students[index][field] = currentScore + 1;
                filterKashfTable();
                debouncedAutoSave();
                saveToHistory();
            }
        }
        function decrementScore(index, field) {
            const currentScore = students[index][field];
            if (currentScore > 0) {
                students[index][field] = currentScore - 1;
                filterKashfTable();
                debouncedAutoSave();
                saveToHistory();
            }
        }
        function saveStudent(index) {
            const student = { ...students[index] };
            const today = new Date();
            const newEntry = {
                behavior: student.behavior,
                score: student.score,
                participationScore: student.participationScore,
                homeworkScore: student.homeworkScore,
                date: today.toLocaleDateString('ar-EG'),
                day: today.toLocaleDateString('ar-EG', { weekday: 'long' })
            };
            let existingStudent = savedStudents.find(s => s.name === student.name && s.grade === student.grade && s.section === student.section);
            if (existingStudent) {
                existingStudent.behaviors.push(newEntry);
                existingStudent.notes = existingStudent.notes || '';
            } else {
                existingStudent = {
                    name: student.name,
                    grade: student.grade,
                    section: student.section,
                    behaviors: [newEntry],
                    notes: ''
                };
                savedStudents.push(existingStudent);
            }
            savedStudents.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            renderSavedTable();
            debouncedAutoSave();
            saveToHistory();
        }
        function saveAllStudents() {
            let allValid = true;
            students.forEach((student, index) => {
                if (!student.name) {
                    alert(`يرجى إدخال اسم الطالب في السطر ${index + 1}`);
                    allValid = false;
                } else if (!student.grade) {
                    alert(`يرجى اختيار الصف للطالب: ${student.name}`);
                    allValid = false;
                } else if (!student.section) {
                    alert(`يرجى اختيار الفصل للطالب: ${student.name}`);
                    allValid = false;
                } else if (!student.behavior || student.behavior === '') {
                    alert(`يرجى اختيار السلوك للطالب: ${student.name}`);
                    allValid = false;
                }
            });
            if (!allValid) return;
            students.forEach((student, index) => {
                saveStudent(index);
            });
            alert('تم حفظ جميع الطلاب بنجاح!');
        }
        function deleteStudent(index) {
            students.splice(index, 1);
            renderKashfTable();
            debouncedAutoSave();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
        }
        function deleteAllKashfRows() {
            students = [];
            renderKashfTable();
            debouncedAutoSave();
            saveToHistory();
            updateSendSections();
            updateFilteredStudentList();
        }
        function updateKashfSections() {
            const gradeFilter = document.getElementById('filterKashfGrade').value;
            const sections = [...new Set(students.filter(s => !gradeFilter || s.grade === gradeFilter).map(s => s.section).filter(s => s))];
            const sectionSelect = document.getElementById('filterKashfSection');
            sectionSelect.innerHTML = '<option value="">جميع الفصول</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
        }
        function filterKashfTable() {
            const gradeFilter = document.getElementById('filterKashfGrade').value;
            const sectionFilter = document.getElementById('filterKashfSection').value;
            const filteredStudents = students.filter(student => 
                (!gradeFilter || student.grade === gradeFilter) &&
                (!sectionFilter || student.section === sectionFilter)
            );
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            const noStudentsMessage = document.getElementById('noStudentsMessage');
            noStudentsMessage.style.display = 'none';
            filteredStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="move-control">
                            <button class="move-btn" onclick="moveRowUp(${students.indexOf(student)})" ${students.indexOf(student) === 0 ? 'disabled' : ''}>↑</button>
                            <button class="move-btn" onclick="moveRowDown(${students.indexOf(student)})" ${students.indexOf(student) === students.length - 1 ? 'disabled' : ''}>↓</button>
                        </div>
                    </td>
                    <td class="student-name"><input type="text" value="${student.name}" onchange="updateStudent(${students.indexOf(student)}, 'name', this.value)"></td>
                    <td>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="grade_${index}" value="الأول متوسط" ${student.grade === 'الأول متوسط' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'grade', this)"> الأول متوسط</label>
                            <label><input type="checkbox" name="grade_${index}" value="الثاني متوسط" ${student.grade === 'الثاني متوسط' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'grade', this)"> الثاني متوسط</label>
                            <label><input type="checkbox" name="grade_${index}" value="الثالث متوسط" ${student.grade === 'الثالث متوسط' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'grade', this)"> الثالث متوسط</label>
                        </div>
                    </td>
                    <td>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="section_${index}" value="1" ${student.section === '1' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'section', this)"> 1</label>
                            <label><input type="checkbox" name="section_${index}" value="2" ${student.section === '2' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'section', this)"> 2</label>
                            <label><input type="checkbox" name="section_${index}" value="3" ${student.section === '3' ? 'checked' : ''} onchange="updateStudent(${students.indexOf(student)}, 'section', this)"> 3</label>
                        </div>
                    </td>
                    <td>
                        <select onchange="updateBehavior(${students.indexOf(student)}, this.value)">
                            <option value="">اختر السلوك</option>
                            <option value="نسي الكتاب" ${student.behavior === 'نسي الكتاب' ? 'selected' : ''}>نسي الكتاب</option>
                            <option value="التحدث أثناء الدرس" ${student.behavior === 'التحدث أثناء الدرس' ? 'selected' : ''}>التحدث أثناء الدرس</option>
                            <option value="متأخر" ${student.behavior === 'متأخر' ? 'selected' : ''}>متأخر</option>
                            <option value="نائم" ${student.behavior === 'نائم' ? 'selected' : ''}>نائم</option>
                            <option value="رجوع" ${student.behavior === 'رجوع' ? 'selected' : ''}>رجوع</option>
                        </select>
                    </td>
                    <td><input type="number" value="${student.score}" min="0" max="20" onchange="updateStudent(${students.indexOf(student)}, 'score', this.value)"></td>
                    <td><button class="save-btn" onclick="saveStudent(${students.indexOf(student)})">حفظ</button></td>
                    <td><button class="delete-btn" onclick="deleteStudent(${students.indexOf(student)})">حذف</button></td>
                    <td>
                        <div class="score-control">
                            <button class="increment-btn" onclick="incrementScore(${students.indexOf(student)}, 'participationScore')">+</button>
                            <span>${student.participationScore}</span>
                            <button class="decrement-btn" onclick="decrementScore(${students.indexOf(student)}, 'participationScore')">-</button>
                        </div>
                    </td>
                    <td>
                        <div class="score-control">
                            <button class="increment-btn" onclick="incrementScore(${students.indexOf(student)}, 'homeworkScore')">+</button>
                            <span>${student.homeworkScore}</span>
                            <button class="decrement-btn" onclick="decrementScore(${students.indexOf(student)}, 'homeworkScore')">-</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            if (filteredStudents.length === 0 && (gradeFilter || sectionFilter)) {
                noStudentsMessage.style.display = 'block';
                noStudentsMessage.textContent = 'لا توجد أسماء تتطابق مع التصفية. حاول تغيير الصف أو الفصل.';
            }
        }
        function exportKashfToExcel() {
            const tempTable = document.createElement('table');
            tempTable.innerHTML = `
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>الصف</th>
                        <th>الفصل</th>
                        <th>السلوك</th>
                        <th>الدرجة</th>
                        <th>م</th>
                        <th>و</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tempTableBody = tempTable.querySelector('tbody');
            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.grade}</td>
                    <td>${student.section}</td>
                    <td>${student.behavior}</td>
                    <td>${student.score}</td>
                    <td>${student.participationScore}</td>
                    <td>${student.homeworkScore}</td>
                `;
                tempTableBody.appendChild(row);
            });
            const ws = XLSX.utils.table_to_sheet(tempTable);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'كشف المتابعة');
            XLSX.writeFile(wb, 'كشف_المتابعة.xlsx');
        }
        function renderSavedTable() {
            const tableBody = document.getElementById('savedTableBody');
            tableBody.innerHTML = '';
            savedStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                const behaviorsHtml = student.behaviors.map(entry => `
                    <div class="behavior-entry">${entry.behavior} (${entry.day} - ${entry.date})</div>
                `).join('');
                const scoresHtml = student.behaviors.map(entry => `
                    <div class="behavior-entry">${entry.score}</div>
                `).join('');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.grade}</td>
                    <td>${student.section}</td>
                    <td>${behaviorsHtml}</td>
                    <td>${scoresHtml}</td>
                    <td><input type="text" value="${student.notes || ''}" onchange="updateSavedStudentNotes(${index}, this.value)"></td>
                    <td><button class="delete-btn" onclick="deleteSavedStudent(${index})">حذف</button></td>
                `;
                tableBody.appendChild(row);
            });
        }
        function updateSavedStudentNotes(index, notes) {
            savedStudents[index].notes = notes;
            debouncedAutoSave();
            saveToHistory();
        }
        function deleteSavedStudent(index) {
            savedStudents.splice(index, 1);
            renderSavedTable();
            debouncedAutoSave();
            saveToHistory();
        }
        function filterSavedTable() {
            const gradeFilter = document.getElementById('filterGrade').value;
            const filteredStudents = savedStudents.filter(student => !gradeFilter || student.grade === gradeFilter);
            const tableBody = document.getElementById('savedTableBody');
            tableBody.innerHTML = '';
            filteredStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                const behaviorsHtml = student.behaviors.map(entry => `
                    <div class="behavior-entry">${entry.behavior} (${entry.day} - ${entry.date})</div>
                `).join('');
                const scoresHtml = student.behaviors.map(entry => `
                    <div class="behavior-entry">${entry.score}</div>
                `).join('');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.grade}</td>
                    <td>${student.section}</td>
                    <td>${behaviorsHtml}</td>
                    <td>${scoresHtml}</td>
                    <td><input type="text" value="${student.notes || ''}" onchange="updateSavedStudentNotes(${savedStudents.indexOf(student)}, this.value)"></td>
                    <td><button class="delete-btn" onclick="deleteSavedStudent(${savedStudents.indexOf(student)})">حذف</button></td>
                `;
                tableBody.appendChild(row);
            });
        }
        function exportToExcel() {
            const table = document.getElementById('savedTable');
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'كشف المتابعة');
            XLSX.writeFile(wb, 'كشف_المتابعة.xlsx');
        }
        function updateStatsChart() {
            const grade = document.getElementById('statsGrade').value;
            const section = document.getElementById('statsSection').value;
            const filteredStudents = savedStudents.filter(student => 
                (!grade || student.grade === grade) &&
                (!section || student.section === section)
            );
            const behaviorCounts = { 'نسي الكتاب': 0, 'التحدث أثناء الدرس': 0, 'متأخر': 0, 'نائم': 0, 'رجوع': 0 };
            filteredStudents.forEach(student => {
                student.behaviors.forEach(entry => {
                    if (entry.behavior && behaviorCounts.hasOwnProperty(entry.behavior)) {
                        behaviorCounts[entry.behavior]++;
                    }
                });
            });
            const ctx = document.getElementById('statsChart').getContext('2d');
            if (statsChart) statsChart.destroy();
            statsChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(behaviorCounts),
                    datasets: [{
                        label: 'عدد المخالفات',
                        data: Object.values(behaviorCounts),
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                        borderColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'إحصائيات السلوك' }
                    }
                }
            });
        }
        function updateStatsSections() {
            const grade = document.getElementById('statsGrade').value;
            const sections = [...new Set(savedStudents.filter(s => !grade || s.grade === grade).map(s => s.section).filter(s => s))];
            const sectionSelect = document.getElementById('statsSection');
            sectionSelect.innerHTML = '<option value="">اختر الفصل</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
        }
        function updateSendSections() {
            const grade = document.getElementById('sendGrade').value;
            const sections = [...new Set(students.filter(s => !grade || s.grade === grade).map(s => s.section).filter(s => s))];
            const sectionSelect = document.getElementById('sendSection');
            sectionSelect.innerHTML = '<option value="">اختر الفصل</option>';
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
            updateFilteredStudentList();
        }
        function updateFilteredStudentList() {
            const grade = document.getElementById('sendGrade').value;
            const section = document.getElementById('sendSection').value;
            const filteredStudents = students.filter(student => 
                (!grade || student.grade === grade) &&
                (!section || student.section === section)
            );
            const studentSelect = document.getElementById('filteredStudents');
            studentSelect.innerHTML = '<option value="">اختر الطالب</option>';
            filteredStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.name;
                option.textContent = student.name;
                studentSelect.appendChild(option);
            });
        }
        function displayStudentDetails() {
            const studentName = document.getElementById('filteredStudents').value;
            if (!studentName) {
                document.getElementById('studentDetailsTable').style.display = 'none';
                document.getElementById('whatsappButton').style.display = 'none';
                return;
            }
            const studentRecords = savedStudents.filter(s => s.name === studentName);
            const tableBody = document.getElementById('studentDetailsBody');
            tableBody.innerHTML = '';
            studentRecords.forEach(record => {
                const behaviorsList = record.behaviors.map(entry => `${entry.behavior} (${entry.day} - ${entry.date})`).join('<br>');
                const scoresList = record.behaviors.map(entry => entry.score).join('<br>');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.name}</td>
                    <td>${record.grade}</td>
                    <td>${record.section}</td>
                    <td>${behaviorsList}</td>
                    <td>${scoresList}</td>
                    <td>${record.notes}</td>
                `;
                tableBody.appendChild(row);
            });
            document.getElementById('studentDetailsTable').style.display = 'table';
            document.getElementById('whatsappButton').style.display = 'block';
        }
        function sendToWhatsApp() {
            const studentName = document.getElementById('filteredStudents').value;
            const studentRecords = savedStudents.filter(s => s.name === studentName);
            let message = `تقرير الطالب: ${studentName}\n\n`;
            studentRecords.forEach(record => {
                record.behaviors.forEach(entry => {
                    message += `التاريخ: ${entry.date}\n`;
                    message += `الصف: ${record.grade}\n`;
                    message += `الفصل: ${record.section}\n`;
                    message += `السلوك: ${entry.behavior}\n`;
                    message += `الدرجة: ${entry.score}\n`;
                    message += `ملاحظات: ${record.notes}\n\n`;
                });
            });
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }
        async function handleMediaUpload(event, grade) {
            const files = event.target.files;
            if (!grade) {
                alert('يرجى اختيار الصف');
                return;
            }
            if (!files.length) return;
            const newGroup = [];
            for (const file of files) {
                const url = URL.createObjectURL(file);
                newGroup.push({
                    blob: file,
                    url: url,
                    type: file.type,
                    name: file.name,
                    description: ''
                });
            }
            mediaGroups[grade].push(newGroup);
            renderMediaItems();
            debouncedAutoSave();
        }
        function addMediaFromLink() {
            const link = document.getElementById('mediaLink').value.trim();
            const grade = document.getElementById('mediaGradeSelect').value;
            if (!link || !grade) {
                alert('يرجى إدخال الرابط واختيار الصف');
                return;
            }
            const type = link.includes('.pdf') ? 'application/pdf' : link.match(/\.(jpeg|jpg|png|gif)$/i) ? 'image' : link.match(/\.(mp4|webm|ogg)$/i) ? 'video' : 'other';
            const newGroup = [{
                url: link,
                type: type,
                name: link.split('/').pop(),
                description: '',
                blob: null
            }];
            mediaGroups[grade].push(newGroup);
            renderMediaItems();
            document.getElementById('mediaLink').value = '';
            debouncedAutoSave();
        }
        function renderMediaItems() {
            const container = document.getElementById('mediaContainer');
            container.innerHTML = '';
            for (const grade in mediaGroups) {
                if (mediaGroups[grade].length === 0) continue;
                const gradeDiv = document.createElement('div');
                gradeDiv.className = 'media-group';
                gradeDiv.innerHTML = `<div class="media-group-header">${grade}</div>`;
                mediaGroups[grade].forEach((group, groupIndex) => {
                    const slideContainer = document.createElement('div');
                    slideContainer.className = 'media-slide-container';
                    group.forEach((item, itemIndex) => {
                        const slide = document.createElement('div');
                        slide.className = `media-slide ${itemIndex === 0 ? 'active' : ''}`;
                        let mediaElement = '';
                        if (item.type.startsWith('image')) {
                            mediaElement = `<img src="${item.url}" alt="${item.name}" onclick="openFullscreen('${item.url}')">`;
                        } else if (item.type.startsWith('video')) {
                            mediaElement = `<video controls><source src="${item.url}" type="${item.type}"></video>`;
                        } else if (item.type === 'application/pdf') {
                            mediaElement = `<embed src="${item.url}" type="application/pdf"><a href="${item.url}" target="_blank">${item.name}</a>`;
                        } else if (item.type.startsWith('audio')) {
                            mediaElement = `<audio controls><source src="${item.url}" type="${item.type}"></audio>`;
                        } else {
                            mediaElement = `<a href="${item.url}" target="_blank">${item.name}</a>`;
                        }
                        slide.innerHTML = `
                            ${mediaElement}
                            <textarea placeholder="أضف وصفًا" onchange="updateMediaDescription('${grade}', ${groupIndex}, ${itemIndex}, this.value)">${item.description}</textarea>
                        `;
                        slideContainer.appendChild(slide);
                    });
                    const controls = document.createElement('div');
                    controls.className = 'media-slide-controls';
                    controls.innerHTML = `
                        <button class="nav-btn" onclick="navigateSlide('${grade}', ${groupIndex}, -1)">❮</button>
                        <button class="delete-btn" onclick="deleteMediaGroup('${grade}', ${groupIndex})">حذف</button>
                        <button class="nav-btn" onclick="navigateSlide('${grade}', ${groupIndex}, 1)">❯</button>
                    `;
                    slideContainer.appendChild(controls);
                    gradeDiv.appendChild(slideContainer);
                });
                container.appendChild(gradeDiv);
            }
        }
        function navigateSlide(grade, groupIndex, direction) {
            const slides = document.querySelectorAll(`.media-group:nth-child(${Object.keys(mediaGroups).indexOf(grade) + 1}) .media-slide-container:nth-child(${groupIndex + 2}) .media-slide`);
            let currentIndex = Array.from(slides).findIndex(slide => slide.classList.contains('active'));
            slides[currentIndex].classList.remove('active');
            currentIndex = (currentIndex + direction + slides.length) % slides.length;
            slides[currentIndex].classList.add('active');
        }
        function deleteMediaGroup(grade, groupIndex) {
            mediaGroups[grade].splice(groupIndex, 1);
            renderMediaItems();
            debouncedAutoSave();
        }
        function updateMediaDescription(grade, groupIndex, itemIndex, description) {
            mediaGroups[grade][groupIndex][itemIndex].description = description;
            debouncedAutoSave();
        }
        function openFullscreen(url) {
            imageSources = [];
            currentImageIndex = -1;
            for (const grade in mediaGroups) {
                mediaGroups[grade].forEach(group => {
                    group.forEach(item => {
                        if (item.type.startsWith('image')) {
                            imageSources.push(item.url);
                            if (item.url === url) {
                                currentImageIndex = imageSources.length - 1;
                            }
                        }
                    });
                });
            }
            if (currentImageIndex >= 0) {
                const overlay = document.getElementById('fullscreenOverlay');
                const fullscreenImage = document.getElementById('fullscreenImage');
                fullscreenImage.src = url;
                overlay.style.display = 'flex';
            }
        }
        function closeFullscreen() {
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.style.display = 'none';
            currentImageIndex = -1;
            imageSources = [];
        }
        function navigateImages(direction) {
            if (imageSources.length === 0) return;
            currentImageIndex = (currentImageIndex + direction + imageSources.length) % imageSources.length;
            document.getElementById('fullscreenImage').src = imageSources[currentImageIndex];
        }
        function saveToHistory() {
            historyStack.push({
                students: JSON.parse(JSON.stringify(students)),
                savedStudents: JSON.parse(JSON.stringify(savedStudents)),
                mediaGroups: JSON.parse(JSON.stringify(mediaGroups))
            });
        }
    </script>
</body>
</html>
